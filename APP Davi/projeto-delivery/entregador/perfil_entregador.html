<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PedidoF√°cil - Meu Perfil</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: #f8f9fa; color: #333; }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; padding: 20px 0; position: sticky; top: 0; z-index: 100;
        }
        .header-content {
            max-width: 1000px; margin: 0 auto; padding: 0 20px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .back-btn { background: rgba(255,255,255,0.2); border: none; color: white;
            padding: 10px 15px; border-radius: 25px; cursor: pointer; }
        .title { font-size: 1.8rem; font-weight: bold; }
        .save-btn { background: rgba(39, 174, 96, 0.8); border: none; color: white;
            padding: 10px 15px; border-radius: 25px; cursor: pointer; font-weight: 600; }
        
        .main { max-width: 1000px; margin: 0 auto; padding: 20px; }
        
        .profile-header { background: white; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            padding: 30px; margin-bottom: 20px; text-align: center; }
        .profile-avatar { width: 100px; height: 100px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 3rem;
            margin: 0 auto 20px; color: white; }
        .profile-name { font-size: 1.8rem; font-weight: 600; color: #333; margin-bottom: 10px; }
        .profile-email { color: #666; font-size: 1rem; margin-bottom: 15px; }
        .profile-status { display: inline-block; padding: 8px 20px; border-radius: 20px; font-weight: 600;
            font-size: 0.9rem; }
        .status-online { background: #d4edda; color: #155724; }
        .status-offline { background: #f8d7da; color: #721c24; }
        
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            padding: 25px; text-align: center; }
        .stat-icon { font-size: 2.5rem; margin-bottom: 15px; }
        .stat-value { font-size: 2rem; font-weight: bold; color: #667eea; margin-bottom: 10px; }
        .stat-label { color: #666; font-size: 0.9rem; }
        
        .form-section { background: white; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            padding: 30px; margin-bottom: 20px; }
        .section-title { font-size: 1.3rem; font-weight: 600; margin-bottom: 25px; color: #333;
            display: flex; align-items: center; gap: 10px; }
        
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
        .form-group { display: flex; flex-direction: column; }
        .form-label { margin-bottom: 8px; color: #333; font-weight: 600; }
        .form-input { padding: 15px; border: 2px solid #e1e5e9; border-radius: 10px; font-size: 16px;
            transition: border-color 0.3s ease; }
        .form-input:focus { outline: none; border-color: #667eea; }
        .form-input:disabled { background: #f8f9fa; color: #666; cursor: not-allowed; }
        
        .password-section { border-top: 1px solid #e1e5e9; padding-top: 25px; margin-top: 25px; }
        .password-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
        
        .toggle-section { display: flex; align-items: center; justify-content: space-between; padding: 15px 0; }
        .toggle-label { font-weight: 600; color: #333; }
        .toggle-switch { position: relative; width: 60px; height: 30px; background: #ccc;
            border-radius: 30px; cursor: pointer; transition: background 0.3s ease; }
        .toggle-switch.active { background: #667eea; }
        .toggle-switch::after { content: ''; position: absolute; top: 3px; left: 3px;
            width: 24px; height: 24px; background: white; border-radius: 50%;
            transition: transform 0.3s ease; }
        .toggle-switch.active::after { transform: translateX(30px); }
        
        .danger-zone { background: #fff5f5; border: 1px solid #fed7d7; border-radius: 15px; padding: 25px; }
        .danger-title { color: #c53030; font-size: 1.2rem; font-weight: 600; margin-bottom: 15px; }
        .danger-text { color: #744210; margin-bottom: 20px; }
        .danger-btn { background: #e53e3e; color: white; border: none; padding: 12px 25px;
            border-radius: 8px; cursor: pointer; font-weight: 600; transition: background 0.3s ease; }
        .danger-btn:hover { background: #c53030; }
        
        .message { padding: 15px; border-radius: 10px; margin-bottom: 20px; text-align: center; }
        .message.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .message.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        
        .loading { display: inline-block; width: 20px; height: 20px; border: 3px solid #ffffff;
            border-radius: 50%; border-top-color: transparent; animation: spin 1s ease-in-out infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        @media (max-width: 768px) { .form-grid { grid-template-columns: 1fr; }
            .password-grid { grid-template-columns: 1fr; } .stats-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <button class="back-btn" onclick="voltarParaHome()">‚Üê Voltar</button>
            <div class="title">üë§ Meu Perfil</div>
            <button class="save-btn" onclick="salvarPerfil()" id="save-btn" style="display: none;">üíæ Salvar</button>
        </div>
    </header>

    <main class="main">
        <div class="profile-header">
            <div class="profile-avatar">üöö</div>
            <div class="profile-name" id="profile-name">Carregando...</div>
            <div class="profile-email" id="profile-email">Carregando...</div>
            <div class="profile-status" id="profile-status">Carregando...</div>
        </div>

        <div class="stats-grid" id="stats-grid">
            <div class="loading">Carregando estat√≠sticas...</div>
        </div>

        <div class="form-section">
            <div class="section-title">üìù Informa√ß√µes Pessoais</div>
            <div class="form-grid">
                <div class="form-group">
                    <label class="form-label" for="nome">Nome Completo</label>
                    <input type="text" class="form-input" id="nome" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="email">E-mail</label>
                    <input type="email" class="form-input" id="email" disabled>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="telefone">Telefone</label>
                    <input type="tel" class="form-input" id="telefone" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="cpf">CPF</label>
                    <input type="text" class="form-input" id="cpf" disabled>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="veiculo">Tipo de Ve√≠culo</label>
                    <select class="form-input" id="veiculo" required>
                        <option value="moto">Moto</option>
                        <option value="bicicleta">Bicicleta</option>
                        <option value="carro">Carro</option>
                        <option value="patinete">Patinete El√©trico</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="placa">Placa (se aplic√°vel)</label>
                    <input type="text" class="form-input" id="placa" placeholder="ABC-1234">
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="endereco">Endere√ßo</label>
                    <input type="text" class="form-input" id="endereco" required>
                </div>
            </div>
        </div>

        <div class="form-section">
            <div class="section-title">üîê Alterar Senha</div>
            <div class="password-section">
                <div class="password-grid">
                    <div class="form-group">
                        <label class="form-label" for="senha-atual">Senha Atual</label>
                        <input type="password" class="form-input" id="senha-atual" placeholder="Digite sua senha atual">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="nova-senha">Nova Senha</label>
                        <input type="password" class="form-input" id="nova-senha" placeholder="Digite a nova senha">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="confirmar-senha">Confirmar Nova Senha</label>
                        <input type="password" class="form-input" id="confirmar-senha" placeholder="Confirme a nova senha">
                    </div>
                </div>
            </div>
        </div>

        <div class="form-section">
            <div class="section-title">‚öôÔ∏è Configura√ß√µes</div>
            <div class="toggle-section">
                <div class="toggle-label">Status de Disponibilidade</div>
                <div class="toggle-switch" id="status-toggle" onclick="toggleStatus()"></div>
            </div>
            
            <div class="toggle-section">
                <div class="toggle-label">Notifica√ß√µes Push</div>
                <div class="toggle-switch" id="notif-toggle" onclick="toggleNotificacoes()"></div>
            </div>
            
            <div class="toggle-section">
                <div class="toggle-label">Modo Escuro</div>
                <div class="toggle-switch" id="tema-toggle" onclick="toggleTema()"></div>
            </div>
        </div>

        <div class="danger-zone">
            <div class="danger-title">‚ö†Ô∏è Zona de Perigo</div>
            <div class="danger-text">
                <p>Essas a√ß√µes s√£o irrevers√≠veis. Tenha certeza antes de prosseguir.</p>
            </div>
            <button class="danger-btn" onclick="deletarConta()">üóëÔ∏è Deletar Conta</button>
        </div>
    </main>

    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "sua-api-key", authDomain: "seu-projeto.firebaseapp.com",
            projectId: "seu-projeto", storageBucket: "seu-projeto.appspot.com",
            messagingSenderId: "123456789", appId: "seu-app-id"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        let currentUser = null;
        let dadosOriginais = {};

        document.addEventListener('DOMContentLoaded', function() {
            verificarAutenticacao();
        });

        function verificarAutenticacao() {
            auth.onAuthStateChanged((user) => {
                if (user) {
                    db.collection('usuarios').doc(user.uid).get().then((doc) => {
                        if (doc.exists && doc.data().tipo === 'entregador') {
                            currentUser = { uid: user.uid, email: user.email, ...doc.data() };
                            carregarPerfil();
                        } else {
                            window.location.href = 'cadastro_login_entregador.html';
                        }
                    });
                } else {
                    window.location.href = 'cadastro_login_entregador.html';
                }
            });
        }

        async function carregarPerfil() {
            if (!currentUser) return;
            
            try {
                const entregadorDoc = await db.collection('entregadores').doc(currentUser.uid).get();
                if (entregadorDoc.exists) {
                    const dados = entregadorDoc.data();
                    exibirPerfil(dados);
                    dadosOriginais = { ...dados };
                }
            } catch (error) {
                console.error('Erro ao carregar perfil:', error);
            }
        }

        function exibirPerfil(dados) {
            // Atualizar header do perfil
            document.getElementById('profile-name').textContent = dados.nome;
            document.getElementById('profile-email').textContent = dados.email;
            
            const statusElement = document.getElementById('profile-status');
            if (dados.disponivel) {
                statusElement.textContent = 'üü¢ Online';
                statusElement.className = 'profile-status status-online';
            } else {
                statusElement.textContent = 'üî¥ Offline';
                statusElement.className = 'profile-status status-offline';
            }
            
            // Atualizar estat√≠sticas
            exibirEstatisticas(dados);
            
            // Preencher formul√°rio
            document.getElementById('nome').value = dados.nome || '';
            document.getElementById('email').value = dados.email || '';
            document.getElementById('telefone').value = dados.telefone || '';
            document.getElementById('cpf').value = dados.cpf || '';
            document.getElementById('veiculo').value = dados.veiculo || 'moto';
            document.getElementById('placa').value = dados.placa || '';
            document.getElementById('endereco').value = dados.endereco || '';
            
            // Configurar toggles
            document.getElementById('status-toggle').classList.toggle('active', dados.disponivel);
            document.getElementById('notif-toggle').classList.toggle('active', dados.notificacoes !== false);
            document.getElementById('tema-toggle').classList.toggle('active', dados.temaEscuro === true);
            
            // Configurar eventos para detectar mudan√ßas
            configurarEventosFormulario();
        }

        function exibirEstatisticas(dados) {
            const statsGrid = document.getElementById('stats-grid');
            statsGrid.innerHTML = `
                <div class="stat-card">
                    <div class="stat-icon">üì¶</div>
                    <div class="stat-value">${dados.totalEntregas || 0}</div>
                    <div class="stat-label">Total de Entregas</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üí∞</div>
                    <div class="stat-value">R$ ${(dados.totalGanhos || 0).toFixed(2)}</div>
                    <div class="stat-label">Total Ganho</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">‚≠ê</div>
                    <div class="stat-value">${(dados.avaliacao || 0).toFixed(1)}</div>
                    <div class="stat-label">Avalia√ß√£o M√©dia</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üìä</div>
                    <div class="stat-value">${dados.totalAvaliacoes || 0}</div>
                    <div class="stat-label">Total de Avalia√ß√µes</div>
                </div>
            `;
        }

        function configurarEventosFormulario() {
            const campos = ['nome', 'telefone', 'veiculo', 'placa', 'endereco'];
            campos.forEach(campo => {
                document.getElementById(campo).addEventListener('input', verificarAlteracoes);
            });
            
            // Campos de senha
            ['senha-atual', 'nova-senha', 'confirmar-senha'].forEach(campo => {
                document.getElementById(campo).addEventListener('input', verificarAlteracoes);
            });
        }

        function verificarAlteracoes() {
            const nome = document.getElementById('nome').value;
            const telefone = document.getElementById('telefone').value;
            const veiculo = document.getElementById('veiculo').value;
            const placa = document.getElementById('placa').value;
            const endereco = document.getElementById('endereco').value;
            const senhaAtual = document.getElementById('senha-atual').value;
            const novaSenha = document.getElementById('nova-senha').value;
            const confirmarSenha = document.getElementById('confirmar-senha').value;
            
            const alteracoes = 
                nome !== (dadosOriginais.nome || '') ||
                telefone !== (dadosOriginais.telefone || '') ||
                veiculo !== (dadosOriginais.veiculo || 'moto') ||
                placa !== (dadosOriginais.placa || '') ||
                endereco !== (dadosOriginais.endereco || '') ||
                senhaAtual || novaSenha || confirmarSenha;
            
            document.getElementById('save-btn').style.display = alteracoes ? 'block' : 'none';
        }

        async function salvarPerfil() {
            const btn = document.getElementById('save-btn');
            btn.disabled = true;
            btn.textContent = 'üîÑ Salvando...';
            
            try {
                const nome = document.getElementById('nome').value;
                const telefone = document.getElementById('telefone').value;
                const veiculo = document.getElementById('veiculo').value;
                const placa = document.getElementById('placa').value;
                const endereco = document.getElementById('endereco').value;
                const senhaAtual = document.getElementById('senha-atual').value;
                const novaSenha = document.getElementById('nova-senha').value;
                const confirmarSenha = document.getElementById('confirmar-senha').value;
                
                // Valida√ß√µes
                if (!nome || !telefone || !veiculo || !endereco) {
                    mostrarMensagem('Por favor, preencha todos os campos obrigat√≥rios', 'error');
                    return;
                }
                
                if (veiculo === 'moto' || veiculo === 'carro') {
                    if (!placa || placa.trim() === '') {
                        mostrarMensagem('Placa √© obrigat√≥ria para motos e carros', 'error');
                        return;
                    }
                }
                
                const dadosAtualizados = {
                    nome: nome,
                    telefone: telefone,
                    veiculo: veiculo,
                    placa: placa,
                    endereco: endereco,
                    dataAtualizacao: new Date()
                };
                
                // Atualizar dados do usu√°rio
                await db.collection('usuarios').doc(currentUser.uid).update(dadosAtualizados);
                await db.collection('entregadores').doc(currentUser.uid).update(dadosAtualizados);
                
                // Alterar senha se necess√°rio
                if (senhaAtual && novaSenha && confirmarSenha) {
                    if (novaSenha !== confirmarSenha) {
                        mostrarMensagem('As senhas n√£o coincidem', 'error');
                        return;
                    }
                    
                    if (novaSenha.length < 6) {
                        mostrarMensagem('A nova senha deve ter pelo menos 6 caracteres', 'error');
                        return;
                    }
                    
                    // Reautenticar usu√°rio
                    const credential = firebase.auth.EmailAuthProvider.credential(currentUser.email, senhaAtual);
                    await auth.currentUser.reauthenticateWithCredential(credential);
                    
                    // Alterar senha
                    await auth.currentUser.updatePassword(novaSenha);
                    
                    // Limpar campos de senha
                    document.getElementById('senha-atual').value = '';
                    document.getElementById('nova-senha').value = '';
                    document.getElementById('confirmar-senha').value = '';
                    
                    mostrarMensagem('Senha alterada com sucesso!', 'success');
                }
                
                // Atualizar dados locais
                currentUser = { ...currentUser, ...dadosAtualizados };
                dadosOriginais = { ...dadosAtualizados };
                verificarAlteracoes();
                
                mostrarMensagem('Perfil atualizado com sucesso!', 'success');
                
            } catch (error) {
                console.error('Erro ao salvar perfil:', error);
                let mensagem = 'Erro ao salvar perfil';
                
                if (error.code === 'auth/wrong-password') {
                    mensagem = 'Senha atual incorreta';
                } else if (error.code === 'auth/weak-password') {
                    mensagem = 'A nova senha √© muito fraca';
                }
                
                mostrarMensagem(mensagem, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'üíæ Salvar';
            }
        }

        async function toggleStatus() {
            if (!currentUser) return;
            
            const novoStatus = !currentUser.disponivel;
            
            try {
                await db.collection('usuarios').doc(currentUser.uid).update({
                    disponivel: novoStatus,
                    dataAtualizacao: new Date()
                });
                
                await db.collection('entregadores').doc(currentUser.uid).update({
                    disponivel: novoStatus,
                    dataAtualizacao: new Date()
                });
                
                currentUser.disponivel = novoStatus;
                dadosOriginais.disponivel = novoStatus;
                
                // Atualizar interface
                const statusElement = document.getElementById('profile-status');
                const statusToggle = document.getElementById('status-toggle');
                
                if (novoStatus) {
                    statusElement.textContent = 'üü¢ Online';
                    statusElement.className = 'profile-status status-online';
                    statusToggle.classList.add('active');
                } else {
                    statusElement.textContent = 'üî¥ Offline';
                    statusElement.className = 'profile-status status-offline';
                    statusToggle.classList.remove('active');
                }
                
                mostrarMensagem(`Status alterado para ${novoStatus ? 'Online' : 'Offline'}`, 'success');
                
            } catch (error) {
                console.error('Erro ao alterar status:', error);
                mostrarMensagem('Erro ao alterar status', 'error');
            }
        }

        async function toggleNotificacoes() {
            if (!currentUser) return;
            
            const novoStatus = !document.getElementById('notif-toggle').classList.contains('active');
            
            try {
                await db.collection('usuarios').doc(currentUser.uid).update({
                    notificacoes: novoStatus,
                    dataAtualizacao: new Date()
                });
                
                await db.collection('entregadores').doc(currentUser.uid).update({
                    notificacoes: novoStatus,
                    dataAtualizacao: new Date()
                });
                
                currentUser.notificacoes = novoStatus;
                dadosOriginais.notificacoes = novoStatus;
                
                document.getElementById('notif-toggle').classList.toggle('active', novoStatus);
                mostrarMensagem(`Notifica√ß√µes ${novoStatus ? 'ativadas' : 'desativadas'}`, 'success');
                
            } catch (error) {
                console.error('Erro ao alterar notifica√ß√µes:', error);
                mostrarMensagem('Erro ao alterar notifica√ß√µes', 'error');
            }
        }

        async function toggleTema() {
            if (!currentUser) return;
            
            const novoStatus = !document.getElementById('tema-toggle').classList.contains('active');
            
            try {
                await db.collection('usuarios').doc(currentUser.uid).update({
                    temaEscuro: novoStatus,
                    dataAtualizacao: new Date()
                });
                
                await db.collection('entregadores').doc(currentUser.uid).update({
                    temaEscuro: novoStatus,
                    dataAtualizacao: new Date()
                });
                
                currentUser.temaEscuro = novoStatus;
                dadosOriginais.temaEscuro = novoStatus;
                
                document.getElementById('tema-toggle').classList.toggle('active', novoStatus);
                mostrarMensagem(`Tema ${novoStatus ? 'escuro' : 'claro'} ativado`, 'success');
                
            } catch (error) {
                console.error('Erro ao alterar tema:', error);
                mostrarMensagem('Erro ao alterar tema', 'error');
            }
        }

        async function deletarConta() {
            if (!currentUser) return;
            
            const confirmacao = confirm('Tem certeza que deseja deletar sua conta? Esta a√ß√£o √© irrevers√≠vel!');
            if (!confirmacao) return;
            
            try {
                // Deletar dados do Firestore
                await db.collection('usuarios').doc(currentUser.uid).delete();
                await db.collection('entregadores').doc(currentUser.uid).delete();
                
                // Deletar conta do Firebase Auth
                await auth.currentUser.delete();
                
                mostrarMensagem('Conta deletada com sucesso', 'success');
                setTimeout(() => {
                    window.location.href = 'cadastro_login_entregador.html';
                }, 2000);
                
            } catch (error) {
                console.error('Erro ao deletar conta:', error);
                mostrarMensagem('Erro ao deletar conta', 'error');
            }
        }

        function mostrarMensagem(texto, tipo) {
            const mensagem = document.createElement('div');
            mensagem.className = `message ${tipo}`;
            mensagem.textContent = texto;
            
            document.querySelector('.main').insertBefore(mensagem, document.querySelector('.main').firstChild);
            
            setTimeout(() => {
                if (mensagem.parentNode) {
                    mensagem.remove();
                }
            }, 5000);
        }

        function voltarParaHome() {
            window.location.href = 'home_entregador.html';
        }
    </script>
</body>
</html>
