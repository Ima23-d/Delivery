<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PedidoF√°cil - Gerenciar Usu√°rios</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: #f8f9fa; color: #333; }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; padding: 20px 0; position: sticky; top: 0; z-index: 100;
        }
        .header-content {
            max-width: 1400px; margin: 0 auto; padding: 0 20px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .back-btn { background: rgba(255,255,255,0.2); border: none; color: white;
            padding: 10px 15px; border-radius: 25px; cursor: pointer; }
        .title { font-size: 1.8rem; font-weight: bold; }
        
        .main { max-width: 1400px; margin: 0 auto; padding: 20px; }
        
        .filtros { background: white; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            padding: 20px; margin-bottom: 20px; }
        .filtros-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; }
        .filtro-item { display: flex; flex-direction: column; }
        .filtro-label { margin-bottom: 8px; color: #333; font-weight: 600; }
        .filtro-input { padding: 10px; border: 2px solid #e1e5e9; border-radius: 8px; font-size: 14px; }
        .filtro-input:focus { outline: none; border-color: #667eea; }
        .aplicar-filtros { background: #667eea; color: white; border: none; padding: 12px 20px;
            border-radius: 8px; cursor: pointer; font-weight: 600; margin-top: 20px; }
        
        .stats-overview { background: white; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            padding: 25px; margin-bottom: 20px; }
        .overview-title { font-size: 1.3rem; font-weight: 600; margin-bottom: 20px; color: #333; }
        .overview-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; }
        .overview-card { background: #f8f9fa; border-radius: 10px; padding: 20px; text-align: center; }
        .overview-value { font-size: 1.8rem; font-weight: bold; color: #667eea; margin-bottom: 8px; }
        .overview-label { color: #666; font-size: 0.9rem; }
        
        .users-container { background: white; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            padding: 25px; margin-bottom: 20px; }
        .users-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .users-title { font-size: 1.3rem; font-weight: 600; color: #333; }
        .add-user-btn { background: #28a745; color: white; border: none; padding: 10px 20px;
            border-radius: 8px; cursor: pointer; font-weight: 600; }
        
        .user-item { border: 1px solid #e1e5e9; border-radius: 10px; padding: 20px; margin-bottom: 15px;
            transition: all 0.3s; }
        .user-item:hover { box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .user-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .user-info h4 { color: #333; margin-bottom: 5px; font-size: 1.1rem; }
        .user-info p { color: #666; font-size: 0.9rem; margin-bottom: 3px; }
        .user-status { padding: 6px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; }
        .status-ativo { background: #d4edda; color: #155724; }
        .status-inativo { background: #f8d7da; color: #721c24; }
        .status-pendente { background: #fff3cd; color: #856404; }
        .status-suspenso { background: #e2e3e5; color: #383d41; }
        
        .user-details { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px; }
        .detail-group h5 { color: #333; margin-bottom: 5px; font-size: 0.9rem; font-weight: 600; }
        .detail-group p { color: #666; font-size: 0.8rem; }
        
        .user-actions { display: flex; gap: 10px; flex-wrap: wrap; }
        .action-btn { padding: 8px 15px; border: none; border-radius: 6px; cursor: pointer; font-size: 0.8rem; font-weight: 600; }
        .btn-edit { background: #17a2b8; color: white; }
        .btn-suspend { background: #ffc107; color: #212529; }
        .btn-activate { background: #28a745; color: white; }
        .btn-delete { background: #dc3545; color: white; }
        .btn-view { background: #6c757d; color: white; }
        
        .pagination { display: flex; justify-content: center; gap: 10px; margin-top: 20px; }
        .page-btn { padding: 10px 15px; border: 1px solid #e1e5e9; background: white; color: #333;
            border-radius: 6px; cursor: pointer; }
        .page-btn.active { background: #667eea; color: white; border-color: #667eea; }
        .page-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: white; margin: 5% auto; padding: 25px; border-radius: 15px;
            width: 90%; max-width: 600px; max-height: 80vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-title { font-size: 1.3rem; font-weight: 600; color: #333; }
        .close { color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close:hover { color: #000; }
        
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; margin-bottom: 8px; color: #333; font-weight: 600; }
        .form-input { width: 100%; padding: 12px; border: 2px solid #e1e5e9; border-radius: 8px; font-size: 14px; }
        .form-input:focus { outline: none; border-color: #667eea; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        
        .modal-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; }
        .btn { padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; }
        .btn-primary { background: #667eea; color: white; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        
        .no-data { text-align: center; padding: 40px; color: #666; }
        .loading { text-align: center; padding: 40px; color: #666; }
        
        .message { position: fixed; top: 20px; right: 20px; z-index: 1000; padding: 15px 20px;
            border-radius: 10px; color: white; font-weight: 600; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .message.success { background: #28a745; }
        .message.error { background: #dc3545; }
        .message.warning { background: #ffc107; color: #212529; }
        
        @media (max-width: 768px) { .filtros-grid { grid-template-columns: 1fr; }
            .overview-grid { grid-template-columns: 1fr; } .user-details { grid-template-columns: 1fr; }
            .form-row { grid-template-columns: 1fr; } .user-actions { flex-direction: column; } }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <button class="back-btn" onclick="voltarParaHome()">‚Üê Voltar</button>
            <div class="title">üë• Gerenciar Usu√°rios</div>
        </div>
    </header>

    <main class="main">
        <div class="filtros">
            <div class="filtros-grid">
                <div class="filtro-item">
                    <label class="filtro-label">Tipo de Usu√°rio</label>
                    <select class="filtro-input" id="filtro-tipo">
                        <option value="">Todos os tipos</option>
                        <option value="cliente">Clientes</option>
                        <option value="restaurante">Restaurantes</option>
                        <option value="entregador">Entregadores</option>
                        <option value="admin">Administradores</option>
                    </select>
                </div>
                
                <div class="filtro-item">
                    <label class="filtro-label">Status</label>
                    <select class="filtro-input" id="filtro-status">
                        <option value="">Todos os status</option>
                        <option value="ativo">Ativo</option>
                        <option value="inativo">Inativo</option>
                        <option value="pendente">Pendente</option>
                        <option value="suspenso">Suspenso</option>
                    </select>
                </div>
                
                <div class="filtro-item">
                    <label class="filtro-label">Buscar</label>
                    <input type="text" class="filtro-input" id="filtro-busca" placeholder="Nome, email ou telefone">
                </div>
                
                <div class="filtro-item">
                    <label class="filtro-label">Ordenar por</label>
                    <select class="filtro-input" id="filtro-ordenacao">
                        <option value="dataCadastro">Data de Cadastro</option>
                        <option value="nome">Nome</option>
                        <option value="email">Email</option>
                        <option value="ultimoAcesso">√öltimo Acesso</option>
                    </select>
                </div>
            </div>
            
            <button class="aplicar-filtros" onclick="aplicarFiltros()">üîç Aplicar Filtros</button>
        </div>

        <div class="stats-overview">
            <div class="overview-title">üìä Vis√£o Geral dos Usu√°rios</div>
            <div class="overview-grid" id="overview-grid">
                <div class="loading">Carregando estat√≠sticas...</div>
            </div>
        </div>

        <div class="users-container">
            <div class="users-header">
                <h2 class="users-title">üë§ Lista de Usu√°rios</h2>
                <button class="add-user-btn" onclick="abrirModalUsuario()">‚ûï Adicionar Usu√°rio</button>
            </div>
            
            <div id="users-container">
                <div class="loading">Carregando usu√°rios...</div>
            </div>
            
            <div class="pagination" id="pagination" style="display: none;"></div>
        </div>
    </main>

    <!-- Modal para Adicionar/Editar Usu√°rio -->
    <div id="userModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle">Adicionar Usu√°rio</h3>
                <span class="close" onclick="fecharModal()">&times;</span>
            </div>
            
            <form id="userForm" onsubmit="salvarUsuario(event)">
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Nome</label>
                        <input type="text" class="form-input" id="modal-nome" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-input" id="modal-email" required>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Telefone</label>
                        <input type="tel" class="form-input" id="modal-telefone" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Tipo de Usu√°rio</label>
                        <select class="form-input" id="modal-tipo" required onchange="mostrarCamposEspecificos()">
                            <option value="">Selecione o tipo</option>
                            <option value="cliente">Cliente</option>
                            <option value="restaurante">Restaurante</option>
                            <option value="entregador">Entregador</option>
                            <option value="admin">Administrador</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group" id="campos-especificos" style="display: none;">
                    <div class="form-row" id="campos-restaurante" style="display: none;">
                        <div class="form-group">
                            <label class="form-label">CNPJ</label>
                            <input type="text" class="form-input" id="modal-cnpj" placeholder="00.000.000/0000-00">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Categoria</label>
                            <input type="text" class="form-input" id="modal-categoria" placeholder="Pizza, Hamb√∫rguer, etc.">
                        </div>
                    </div>
                    
                    <div class="form-row" id="campos-entregador" style="display: none;">
                        <div class="form-group">
                            <label class="form-label">CPF</label>
                            <input type="text" class="form-input" id="modal-cpf" placeholder="000.000.000-00">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Ve√≠culo</label>
                            <select class="form-input" id="modal-veiculo">
                                <option value="moto">Moto</option>
                                <option value="bicicleta">Bicicleta</option>
                                <option value="carro">Carro</option>
                                <option value="patinete">Patinete</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group" id="campos-admin" style="display: none;">
                        <label class="form-label">Cargo/Fun√ß√£o</label>
                        <input type="text" class="form-input" id="modal-cargo" placeholder="Gerente, Diretor, etc.">
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Endere√ßo</label>
                    <input type="text" class="form-input" id="modal-endereco" required>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Senha</label>
                        <input type="password" class="form-input" id="modal-senha" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Confirmar Senha</label>
                        <input type="password" class="form-input" id="modal-confirmar-senha" required>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Status</label>
                    <select class="form-input" id="modal-status" required>
                        <option value="ativo">Ativo</option>
                        <option value="inativo">Inativo</option>
                        <option value="pendente">Pendente</option>
                        <option value="suspenso">Suspenso</option>
                    </select>
                </div>
                
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="fecharModal()">Cancelar</button>
                    <button type="submit" class="btn btn-primary" id="saveBtn">üíæ Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "sua-api-key", authDomain: "seu-projeto.firebaseapp.com",
            projectId: "seu-projeto", storageBucket: "seu-projeto.appspot.com",
            messagingSenderId: "123456789", appId: "seu-app-id"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        let currentUser = null;
        let usuarios = [];
        let usuariosFiltrados = [];
        let usuarioEditando = null;
        let paginaAtual = 1;
        const itensPorPagina = 10;
        let unsubscribeUsuarios = null;

        document.addEventListener('DOMContentLoaded', function() {
            verificarAutenticacao();
        });

        function verificarAutenticacao() {
            auth.onAuthStateChanged((user) => {
                if (user) {
                    db.collection('usuarios').doc(user.uid).get().then((doc) => {
                        if (doc.exists && doc.data().tipo === 'admin') {
                            currentUser = { uid: user.uid, email: user.email, ...doc.data() };
                            carregarDados();
                        } else {
                            window.location.href = 'cadastro_login_admin.html';
                        }
                    });
                } else {
                    window.location.href = 'cadastro_login_admin.html';
                }
            });
        }

        async function carregarDados() {
            try {
                await carregarUsuarios();
                await carregarEstatisticas();
            } catch (error) {
                console.error('Erro ao carregar dados:', error);
            }
        }

        async function carregarUsuarios() {
            if (unsubscribeUsuarios) {
                unsubscribeUsuarios();
            }

            unsubscribeUsuarios = db.collection('usuarios')
                .orderBy('dataCadastro', 'desc')
                .onSnapshot((snapshot) => {
                    usuarios = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    aplicarFiltros();
                }, (error) => {
                    console.error('Erro ao carregar usu√°rios:', error);
                });
        }

        async function carregarEstatisticas() {
            try {
                const totalUsuarios = usuarios.length;
                const usuariosAtivos = usuarios.filter(u => u.ativo).length;
                const clientes = usuarios.filter(u => u.tipo === 'cliente').length;
                const restaurantes = usuarios.filter(u => u.tipo === 'restaurante').length;
                const entregadores = usuarios.filter(u => u.tipo === 'entregador').length;
                const admins = usuarios.filter(u => u.tipo === 'admin').length;
                
                const overviewGrid = document.getElementById('overview-grid');
                overviewGrid.innerHTML = `
                    <div class="overview-card">
                        <div class="overview-value">${totalUsuarios}</div>
                        <div class="overview-label">Total de Usu√°rios</div>
                    </div>
                    <div class="overview-card">
                        <div class="overview-value">${usuariosAtivos}</div>
                        <div class="overview-label">Usu√°rios Ativos</div>
                    </div>
                    <div class="overview-card">
                        <div class="overview-value">${clientes}</div>
                        <div class="overview-label">Clientes</div>
                    </div>
                    <div class="overview-card">
                        <div class="overview-value">${restaurantes}</div>
                        <div class="overview-label">Restaurantes</div>
                    </div>
                    <div class="overview-card">
                        <div class="overview-value">${entregadores}</div>
                        <div class="overview-label">Entregadores</div>
                    </div>
                    <div class="overview-card">
                        <div class="overview-value">${admins}</div>
                        <div class="overview-label">Administradores</div>
                    </div>
                `;
            } catch (error) {
                console.error('Erro ao carregar estat√≠sticas:', error);
            }
        }

        function aplicarFiltros() {
            const tipo = document.getElementById('filtro-tipo').value;
            const status = document.getElementById('filtro-status').value;
            const busca = document.getElementById('filtro-busca').value.toLowerCase();
            const ordenacao = document.getElementById('filtro-ordenacao').value;
            
            let usuariosFiltradosTemp = usuarios;
            
            // Filtrar por tipo
            if (tipo) {
                usuariosFiltradosTemp = usuariosFiltradosTemp.filter(u => u.tipo === tipo);
            }
            
            // Filtrar por status
            if (status) {
                usuariosFiltradosTemp = usuariosFiltradosTemp.filter(u => u.status === status);
            }
            
            // Filtrar por busca
            if (busca) {
                usuariosFiltradosTemp = usuariosFiltradosTemp.filter(u => 
                    u.nome?.toLowerCase().includes(busca) ||
                    u.email?.toLowerCase().includes(busca) ||
                    u.telefone?.includes(busca)
                );
            }
            
            // Ordenar
            usuariosFiltradosTemp.sort((a, b) => {
                switch (ordenacao) {
                    case 'nome':
                        return (a.nome || '').localeCompare(b.nome || '');
                    case 'email':
                        return (a.email || '').localeCompare(b.email || '');
                    case 'ultimoAcesso':
                        return (b.ultimoAcesso || 0) - (a.ultimoAcesso || 0);
                    default:
                        return (b.dataCadastro || 0) - (a.dataCadastro || 0);
                }
            });
            
            usuariosFiltrados = usuariosFiltradosTemp;
            paginaAtual = 1;
            exibirUsuarios();
        }

        function exibirUsuarios() {
            const container = document.getElementById('users-container');
            
            if (usuariosFiltrados.length === 0) {
                container.innerHTML = '<div class="no-data">Nenhum usu√°rio encontrado</div>';
                document.getElementById('pagination').style.display = 'none';
                return;
            }
            
            const totalPaginas = Math.ceil(usuariosFiltrados.length / itensPorPagina);
            const inicio = (paginaAtual - 1) * itensPorPagina;
            const fim = inicio + itensPorPagina;
            const usuariosPagina = usuariosFiltrados.slice(inicio, fim);
            
            container.innerHTML = usuariosPagina.map(usuario => `
                <div class="user-item">
                    <div class="user-header">
                        <div class="user-info">
                            <h4>${usuario.nome || 'Nome n√£o informado'}</h4>
                            <p>üìß ${usuario.email}</p>
                            <p>üì± ${usuario.telefone || 'Telefone n√£o informado'}</p>
                            <p>üë§ ${getTipoNome(usuario.tipo)}</p>
                        </div>
                        <div class="user-status status-${usuario.status || 'ativo'}">
                            ${getStatusNome(usuario.status || 'ativo')}
                        </div>
                    </div>
                    
                    <div class="user-details">
                        <div class="detail-group">
                            <h5>üìç Endere√ßo</h5>
                            <p>${usuario.endereco || 'Endere√ßo n√£o informado'}</p>
                        </div>
                        
                        <div class="detail-group">
                            <h5>üìÖ Data de Cadastro</h5>
                            <p>${usuario.dataCadastro ? new Date(usuario.dataCadastro.toDate()).toLocaleDateString('pt-BR') : 'Data n√£o informada'}</p>
                        </div>
                        
                        <div class="detail-group">
                            <h5>üïí √öltimo Acesso</h5>
                            <p>${usuario.ultimoAcesso ? new Date(usuario.ultimoAcesso.toDate()).toLocaleDateString('pt-BR') : 'Nunca acessou'}</p>
                        </div>
                        
                        ${usuario.tipo === 'restaurante' ? `
                            <div class="detail-group">
                                <h5>üè™ CNPJ</h5>
                                <p>${usuario.cnpj || 'CNPJ n√£o informado'}</p>
                            </div>
                            <div class="detail-group">
                                <h5>üçΩÔ∏è Categoria</h5>
                                <p>${usuario.categoria || 'Categoria n√£o informada'}</p>
                            </div>
                        ` : ''}
                        
                        ${usuario.tipo === 'entregador' ? `
                            <div class="detail-group">
                                <h5>üÜî CPF</h5>
                                <p>${usuario.cpf || 'CPF n√£o informado'}</p>
                            </div>
                            <div class="detail-group">
                                <h5>üöó Ve√≠culo</h5>
                                <p>${usuario.veiculo || 'Ve√≠culo n√£o informado'}</p>
                            </div>
                        ` : ''}
                        
                        ${usuario.tipo === 'admin' ? `
                            <div class="detail-group">
                                <h5>üëë Cargo</h5>
                                <p>${usuario.cargo || 'Cargo n√£o informado'}</p>
                            </div>
                        ` : ''}
                    </div>
                    
                    <div class="user-actions">
                        <button class="action-btn btn-view" onclick="verUsuario('${usuario.id}')">üëÅÔ∏è Ver</button>
                        <button class="action-btn btn-edit" onclick="editarUsuario('${usuario.id}')">‚úèÔ∏è Editar</button>
                        ${usuario.status === 'ativo' ? 
                            `<button class="action-btn btn-suspend" onclick="alterarStatus('${usuario.id}', 'suspenso')">‚è∏Ô∏è Suspender</button>` :
                            `<button class="action-btn btn-activate" onclick="alterarStatus('${usuario.id}', 'ativo')">‚úÖ Ativar</button>`
                        }
                        <button class="action-btn btn-delete" onclick="deletarUsuario('${usuario.id}')">üóëÔ∏è Deletar</button>
                    </div>
                </div>
            `).join('');
            
            // Exibir pagina√ß√£o
            if (totalPaginas > 1) {
                exibirPaginacao(totalPaginas);
            } else {
                document.getElementById('pagination').style.display = 'none';
            }
        }

        function exibirPaginacao(totalPaginas) {
            const pagination = document.getElementById('pagination');
            pagination.style.display = 'flex';
            
            let paginacaoHTML = '';
            
            if (paginaAtual > 1) {
                paginacaoHTML += `<button class="page-btn" onclick="mudarPagina(${paginaAtual - 1})">‚Üê Anterior</button>`;
            }
            
            for (let i = 1; i <= totalPaginas; i++) {
                if (i === paginaAtual) {
                    paginacaoHTML += `<button class="page-btn active">${i}</button>`;
                } else {
                    paginacaoHTML += `<button class="page-btn" onclick="mudarPagina(${i})">${i}</button>`;
                }
            }
            
            if (paginaAtual < totalPaginas) {
                paginacaoHTML += `<button class="page-btn" onclick="mudarPagina(${paginaAtual + 1})">Pr√≥xima ‚Üí</button>`;
            }
            
            pagination.innerHTML = paginacaoHTML;
        }

        function mudarPagina(pagina) {
            paginaAtual = pagina;
            exibirUsuarios();
        }

        function getTipoNome(tipo) {
            switch (tipo) {
                case 'cliente': return 'Cliente';
                case 'restaurante': return 'Restaurante';
                case 'entregador': return 'Entregador';
                case 'admin': return 'Administrador';
                default: return 'Desconhecido';
            }
        }

        function getStatusNome(status) {
            switch (status) {
                case 'ativo': return 'Ativo';
                case 'inativo': return 'Inativo';
                case 'pendente': return 'Pendente';
                case 'suspenso': return 'Suspenso';
                default: return 'Ativo';
            }
        }

        function abrirModalUsuario() {
            usuarioEditando = null;
            document.getElementById('modalTitle').textContent = 'Adicionar Usu√°rio';
            document.getElementById('userForm').reset();
            document.getElementById('campos-especificos').style.display = 'none';
            document.getElementById('userModal').style.display = 'block';
        }

        function fecharModal() {
            document.getElementById('userModal').style.display = 'none';
            usuarioEditando = null;
        }

        function mostrarCamposEspecificos() {
            const tipo = document.getElementById('modal-tipo').value;
            const camposEspecificos = document.getElementById('campos-especificos');
            const camposRestaurante = document.getElementById('campos-restaurante');
            const camposEntregador = document.getElementById('campos-entregador');
            const camposAdmin = document.getElementById('campos-admin');
            
            camposEspecificos.style.display = 'block';
            camposRestaurante.style.display = 'none';
            camposEntregador.style.display = 'none';
            camposAdmin.style.display = 'none';
            
            switch (tipo) {
                case 'restaurante':
                    camposRestaurante.style.display = 'grid';
                    break;
                case 'entregador':
                    camposEntregador.style.display = 'grid';
                    break;
                case 'admin':
                    camposAdmin.style.display = 'block';
                    break;
            }
        }

        async function salvarUsuario(event) {
            event.preventDefault();
            
            const btn = document.getElementById('saveBtn');
            btn.disabled = true;
            btn.textContent = 'üîÑ Salvando...';
            
            try {
                const dados = {
                    nome: document.getElementById('modal-nome').value,
                    email: document.getElementById('modal-email').value,
                    telefone: document.getElementById('modal-telefone').value,
                    tipo: document.getElementById('modal-tipo').value,
                    endereco: document.getElementById('modal-endereco').value,
                    status: document.getElementById('modal-status').value,
                    dataAtualizacao: new Date()
                };
                
                // Adicionar campos espec√≠ficos
                if (dados.tipo === 'restaurante') {
                    dados.cnpj = document.getElementById('modal-cnpj').value;
                    dados.categoria = document.getElementById('modal-categoria').value;
                } else if (dados.tipo === 'entregador') {
                    dados.cpf = document.getElementById('modal-cpf').value;
                    dados.veiculo = document.getElementById('modal-veiculo').value;
                } else if (dados.tipo === 'admin') {
                    dados.cargo = document.getElementById('modal-cargo').value;
                }
                
                if (usuarioEditando) {
                    // Editar usu√°rio existente
                    await db.collection('usuarios').doc(usuarioEditando.id).update(dados);
                    mostrarMensagem('Usu√°rio atualizado com sucesso!', 'success');
                } else {
                    // Criar novo usu√°rio
                    const senha = document.getElementById('modal-senha').value;
                    const confirmarSenha = document.getElementById('modal-confirmar-senha').value;
                    
                    if (senha !== confirmarSenha) {
                        mostrarMensagem('As senhas n√£o coincidem', 'error');
                        return;
                    }
                    
                    // Criar usu√°rio no Firebase Auth
                    const userCredential = await auth.createUserWithEmailAndPassword(dados.email, senha);
                    const user = userCredential.user;
                    
                    // Salvar dados no Firestore
                    dados.uid = user.uid;
                    dados.dataCadastro = new Date();
                    dados.ativo = dados.status === 'ativo';
                    
                    await db.collection('usuarios').doc(user.uid).set(dados);
                    
                    // Criar documento espec√≠fico se necess√°rio
                    if (dados.tipo === 'restaurante') {
                        await db.collection('restaurantes').doc(user.uid).set({
                            id: user.uid,
                            ...dados,
                            avaliacao: 0,
                            totalAvaliacoes: 0,
                            taxaEntrega: 0,
                            tempoMedioPreparo: 30
                        });
                    } else if (dados.tipo === 'entregador') {
                        await db.collection('entregadores').doc(user.uid).set({
                            id: user.uid,
                            ...dados,
                            disponivel: true,
                            avaliacao: 0,
                            totalAvaliacoes: 0,
                            totalEntregas: 0,
                            totalGanhos: 0
                        });
                    }
                    
                    mostrarMensagem('Usu√°rio criado com sucesso!', 'success');
                }
                
                fecharModal();
                
            } catch (error) {
                console.error('Erro ao salvar usu√°rio:', error);
                mostrarMensagem('Erro ao salvar usu√°rio: ' + error.message, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'üíæ Salvar';
            }
        }

        async function editarUsuario(usuarioId) {
            const usuario = usuarios.find(u => u.id === usuarioId);
            if (!usuario) return;
            
            usuarioEditando = usuario;
            document.getElementById('modalTitle').textContent = 'Editar Usu√°rio';
            
            // Preencher formul√°rio
            document.getElementById('modal-nome').value = usuario.nome || '';
            document.getElementById('modal-email').value = usuario.email || '';
            document.getElementById('modal-telefone').value = usuario.telefone || '';
            document.getElementById('modal-tipo').value = usuario.tipo || '';
            document.getElementById('modal-endereco').value = usuario.endereco || '';
            document.getElementById('modal-status').value = usuario.status || 'ativo';
            
            // Mostrar campos espec√≠ficos
            mostrarCamposEspecificos();
            
            // Preencher campos espec√≠ficos
            if (usuario.tipo === 'restaurante') {
                document.getElementById('modal-cnpj').value = usuario.cnpj || '';
                document.getElementById('modal-categoria').value = usuario.categoria || '';
            } else if (usuario.tipo === 'entregador') {
                document.getElementById('modal-cpf').value = usuario.cpf || '';
                document.getElementById('modal-veiculo').value = usuario.veiculo || 'moto';
            } else if (usuario.tipo === 'admin') {
                document.getElementById('modal-cargo').value = usuario.cargo || '';
            }
            
            // Ocultar campos de senha para edi√ß√£o
            document.getElementById('modal-senha').parentNode.style.display = 'none';
            document.getElementById('modal-confirmar-senha').parentNode.style.display = 'none';
            
            document.getElementById('userModal').style.display = 'block';
        }

        async function alterarStatus(usuarioId, novoStatus) {
            try {
                await db.collection('usuarios').doc(usuarioId).update({
                    status: novoStatus,
                    ativo: novoStatus === 'ativo',
                    dataAtualizacao: new Date()
                });
                
                mostrarMensagem(`Status alterado para ${getStatusNome(novoStatus)}`, 'success');
                
            } catch (error) {
                console.error('Erro ao alterar status:', error);
                mostrarMensagem('Erro ao alterar status', 'error');
            }
        }

        async function deletarUsuario(usuarioId) {
            if (!confirm('Tem certeza que deseja deletar este usu√°rio? Esta a√ß√£o n√£o pode ser desfeita.')) {
                return;
            }
            
            try {
                await db.collection('usuarios').doc(usuarioId).delete();
                mostrarMensagem('Usu√°rio deletado com sucesso!', 'success');
                
            } catch (error) {
                console.error('Erro ao deletar usu√°rio:', error);
                mostrarMensagem('Erro ao deletar usu√°rio', 'error');
            }
        }

        function verUsuario(usuarioId) {
            const usuario = usuarios.find(u => u.id === usuarioId);
            if (!usuario) return;
            
            alert(`Detalhes do Usu√°rio:\n\nNome: ${usuario.nome}\nEmail: ${usuario.email}\nTipo: ${getTipoNome(usuario.tipo)}\nStatus: ${getStatusNome(usuario.status)}\nEndere√ßo: ${usuario.endereco}\nData de Cadastro: ${usuario.dataCadastro ? new Date(usuario.dataCadastro.toDate()).toLocaleDateString('pt-BR') : 'N/A'}`);
        }

        function mostrarMensagem(texto, tipo) {
            const mensagem = document.createElement('div');
            mensagem.className = `message ${tipo}`;
            mensagem.textContent = texto;
            
            document.body.appendChild(mensagem);
            
            setTimeout(() => {
                if (mensagem.parentNode) {
                    mensagem.remove();
                }
            }, 3000);
        }

        function voltarParaHome() {
            if (unsubscribeUsuarios) {
                unsubscribeUsuarios();
            }
            window.location.href = 'home_admin.html';
        }

        // Fechar modal ao clicar fora
        window.onclick = function(event) {
            const modal = document.getElementById('userModal');
            if (event.target === modal) {
                fecharModal();
            }
        }
    </script>
</body>
</html>
