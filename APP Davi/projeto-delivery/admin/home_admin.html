<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PedidoF√°cil - Painel Admin</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: #f8f9fa; color: #333; }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; padding: 20px 0; position: sticky; top: 0; z-index: 100;
        }
        .header-content {
            max-width: 1400px; margin: 0 auto; padding: 0 20px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .admin-info { display: flex; align-items: center; gap: 15px; }
        .admin-avatar { width: 40px; height: 40px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; }
        .admin-details h3 { font-size: 1rem; margin-bottom: 2px; }
        .admin-details p { font-size: 0.8rem; opacity: 0.8; }
        .logout-btn { background: rgba(255,255,255,0.2); border: none; color: white; padding: 10px 15px; border-radius: 25px; cursor: pointer; }
        
        .main { max-width: 1400px; margin: 0 auto; padding: 20px; }
        
        .welcome-section { background: white; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); padding: 30px; margin-bottom: 30px; }
        .welcome-title { font-size: 2rem; font-weight: bold; color: #333; margin-bottom: 10px; }
        .welcome-subtitle { color: #666; font-size: 1.1rem; margin-bottom: 20px; }
        .platform-status { display: inline-block; background: #28a745; color: white; padding: 8px 16px; border-radius: 20px; font-weight: 600; }
        
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); padding: 25px; text-align: center; }
        .stat-icon { font-size: 2.5rem; margin-bottom: 15px; }
        .stat-value { font-size: 2rem; font-weight: bold; color: #667eea; margin-bottom: 8px; }
        .stat-label { color: #666; font-size: 0.9rem; }
        .stat-change { font-size: 0.8rem; padding: 4px 8px; border-radius: 12px; font-weight: 600; margin-top: 10px; }
        .change-up { background: #d4edda; color: #155724; }
        .change-down { background: #f8d7da; color: #721c24; }
        
        .quick-actions { background: white; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); padding: 25px; margin-bottom: 30px; }
        .actions-title { font-size: 1.3rem; font-weight: 600; margin-bottom: 20px; color: #333; }
        .actions-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        .action-card { background: #f8f9fa; border-radius: 10px; padding: 20px; text-align: center; cursor: pointer; transition: all 0.3s; border: 2px solid transparent; }
        .action-card:hover { transform: translateY(-3px); border-color: #667eea; box-shadow: 0 8px 25px rgba(102, 126, 234, 0.2); }
        .action-icon { font-size: 2rem; margin-bottom: 10px; }
        .action-title { font-weight: 600; color: #333; margin-bottom: 5px; }
        .action-desc { color: #666; font-size: 0.8rem; }
        
        .recent-activity { background: white; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); padding: 25px; margin-bottom: 30px; }
        .activity-title { font-size: 1.3rem; font-weight: 600; margin-bottom: 20px; color: #333; }
        .activity-item { display: flex; align-items: center; gap: 15px; padding: 15px 0; border-bottom: 1px solid #f1f3f4; }
        .activity-item:last-child { border-bottom: none; }
        .activity-icon { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; }
        .activity-icon.user { background: #e3f2fd; color: #1976d2; }
        .activity-icon.restaurant { background: #e8f5e8; color: #388e3c; }
        .activity-icon.order { background: #fff3e0; color: #f57c00; }
        .activity-icon.delivery { background: #f3e5f5; color: #7b1fa2; }
        .activity-content h4 { color: #333; margin-bottom: 5px; font-size: 0.9rem; }
        .activity-content p { color: #666; font-size: 0.8rem; }
        .activity-time { color: #999; font-size: 0.7rem; margin-left: auto; }
        
        .system-alerts { background: white; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); padding: 25px; }
        .alerts-title { font-size: 1.3rem; font-weight: 600; margin-bottom: 20px; color: #333; }
        .alert-item { padding: 15px; border-radius: 10px; margin-bottom: 15px; border-left: 4px solid; }
        .alert-item:last-child { margin-bottom: 0; }
        .alert-warning { background: #fff3cd; border-left-color: #ffc107; color: #856404; }
        .alert-info { background: #d1ecf1; border-left-color: #17a2b8; color: #0c5460; }
        .alert-success { background: #d4edda; border-left-color: #28a745; color: #155724; }
        .alert-danger { background: #f8d7da; border-left-color: #dc3545; color: #721c24; }
        .alert-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .alert-title { font-weight: 600; font-size: 0.9rem; }
        .alert-time { font-size: 0.7rem; opacity: 0.8; }
        .alert-message { font-size: 0.8rem; line-height: 1.4; }
        
        .no-data { text-align: center; padding: 40px; color: #666; }
        .loading { text-align: center; padding: 40px; color: #666; }
        
        @media (max-width: 768px) { .stats-grid { grid-template-columns: 1fr; }
            .actions-grid { grid-template-columns: repeat(2, 1fr); }
            .admin-info { flex-direction: column; gap: 10px; text-align: center; } }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="admin-info">
                <div class="admin-avatar">üëë</div>
                <div class="admin-details">
                    <h3 id="admin-name">Admin</h3>
                    <p id="admin-role">Administrador</p>
                </div>
            </div>
            <button class="logout-btn" onclick="fazerLogout()">üö™ Sair</button>
        </div>
    </header>

    <main class="main">
        <div class="welcome-section">
            <h1 class="welcome-title">Bem-vindo ao Painel Administrativo</h1>
            <p class="welcome-subtitle">Gerencie toda a plataforma PedidoF√°cil de um s√≥ lugar</p>
            <span class="platform-status">üü¢ Plataforma Online</span>
        </div>

        <div class="stats-grid" id="stats-grid">
            <div class="loading">Carregando estat√≠sticas...</div>
        </div>

        <div class="quick-actions">
            <h2 class="actions-title">‚ö° A√ß√µes R√°pidas</h2>
            <div class="actions-grid">
                <div class="action-card" onclick="irPara('gerenciar_usuarios.html')">
                    <div class="action-icon">üë•</div>
                    <div class="action-title">Usu√°rios</div>
                    <div class="action-desc">Gerenciar clientes, restaurantes e entregadores</div>
                </div>
                
                <div class="action-card" onclick="irPara('gerenciar_restaurantes.html')">
                    <div class="action-icon">üè™</div>
                    <div class="action-title">Restaurantes</div>
                    <div class="action-desc">Aprovar, suspender e configurar restaurantes</div>
                </div>
                
                <div class="action-card" onclick="irPara('gerenciar_entregadores.html')">
                    <div class="action-icon">üöö</div>
                    <div class="action-title">Entregadores</div>
                    <div class="action-desc">Gerenciar cadastros e status dos entregadores</div>
                </div>
                
                <div class="action-card" onclick="irPara('gerenciar_pedidos.html')">
                    <div class="action-icon">üì¶</div>
                    <div class="action-title">Pedidos</div>
                    <div class="action-desc">Monitorar e gerenciar todos os pedidos</div>
                </div>
                
                <div class="action-card" onclick="irPara('relatorios_admin.html')">
                    <div class="action-icon">üìä</div>
                    <div class="action-title">Relat√≥rios</div>
                    <div class="action-desc">Visualizar estat√≠sticas e relat√≥rios da plataforma</div>
                </div>
                
                <div class="action-card" onclick="irPara('configuracoes_admin.html')">
                    <div class="action-icon">‚öôÔ∏è</div>
                    <div class="action-title">Configura√ß√µes</div>
                    <div class="action-desc">Configurar taxas, regras e par√¢metros do sistema</div>
                </div>
            </div>
        </div>

        <div class="recent-activity">
            <h2 class="activity-title">üìã Atividade Recente</h2>
            <div id="activity-container">
                <div class="loading">Carregando atividades...</div>
            </div>
        </div>

        <div class="system-alerts">
            <h2 class="alerts-title">üö® Alertas do Sistema</h2>
            <div id="alerts-container">
                <div class="loading">Carregando alertas...</div>
            </div>
        </div>
    </main>

    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "sua-api-key", authDomain: "seu-projeto.firebaseapp.com",
            projectId: "seu-projeto", storageBucket: "seu-projeto.appspot.com",
            messagingSenderId: "123456789", appId: "seu-app-id"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        let currentUser = null;
        let unsubscribeStats = null;
        let unsubscribeActivity = null;

        document.addEventListener('DOMContentLoaded', function() {
            verificarAutenticacao();
        });

        function verificarAutenticacao() {
            auth.onAuthStateChanged((user) => {
                if (user) {
                    db.collection('usuarios').doc(user.uid).get().then((doc) => {
                        if (doc.exists && doc.data().tipo === 'admin') {
                            currentUser = { uid: user.uid, email: user.email, ...doc.data() };
                            atualizarInterface();
                            carregarDados();
                        } else {
                            window.location.href = 'cadastro_login_admin.html';
                        }
                    });
                } else {
                    window.location.href = 'cadastro_login_admin.html';
                }
            });
        }

        function atualizarInterface() {
            document.getElementById('admin-name').textContent = currentUser.nome;
            document.getElementById('admin-role').textContent = currentUser.cargo || 'Administrador';
        }

        async function carregarDados() {
            try {
                await carregarEstatisticas();
                await carregarAtividadesRecentes();
                await carregarAlertasSistema();
            } catch (error) {
                console.error('Erro ao carregar dados:', error);
            }
        }

        async function carregarEstatisticas() {
            try {
                // Carregar estat√≠sticas em tempo real
                unsubscribeStats = db.collection('estatisticas_plataforma').doc('geral')
                    .onSnapshot((doc) => {
                        if (doc.exists) {
                            const stats = doc.data();
                            exibirEstatisticas(stats);
                        } else {
                            // Se n√£o existir, criar estat√≠sticas padr√£o
                            criarEstatisticasPadrao();
                        }
                    }, (error) => {
                        console.error('Erro ao carregar estat√≠sticas:', error);
                        criarEstatisticasPadrao();
                    });
            } catch (error) {
                console.error('Erro ao carregar estat√≠sticas:', error);
                criarEstatisticasPadrao();
            }
        }

        async function criarEstatisticasPadrao() {
            try {
                // Contar usu√°rios ativos
                const usuariosSnapshot = await db.collection('usuarios').where('ativo', '==', true).get();
                const restaurantesSnapshot = await db.collection('restaurantes').where('ativo', '==', true).get();
                const entregadoresSnapshot = await db.collection('entregadores').where('ativo', '==', true).get();
                const pedidosSnapshot = await db.collection('pedidos').get();
                
                const stats = {
                    totalUsuarios: usuariosSnapshot.size,
                    totalRestaurantes: restaurantesSnapshot.size,
                    totalEntregadores: entregadoresSnapshot.size,
                    totalPedidos: pedidosSnapshot.size,
                    pedidosHoje: 0,
                    pedidosSemana: 0,
                    pedidosMes: 0,
                    receitaTotal: 0,
                    receitaHoje: 0,
                    receitaSemana: 0,
                    receitaMes: 0,
                    ultimaAtualizacao: new Date()
                };
                
                // Calcular pedidos por per√≠odo
                const hoje = new Date();
                const inicioSemana = new Date(hoje.getTime() - 7 * 24 * 60 * 60 * 1000);
                const inicioMes = new Date(hoje.getTime() - 30 * 24 * 60 * 60 * 1000);
                
                pedidosSnapshot.forEach(doc => {
                    const pedido = doc.data();
                    const dataPedido = pedido.dataPedido.toDate();
                    
                    if (dataPedido.toDateString() === hoje.toDateString()) {
                        stats.pedidosHoje++;
                        stats.receitaHoje += pedido.total || 0;
                    }
                    
                    if (dataPedido >= inicioSemana) {
                        stats.pedidosSemana++;
                        stats.receitaSemana += pedido.total || 0;
                    }
                    
                    if (dataPedido >= inicioMes) {
                        stats.pedidosMes++;
                        stats.receitaMes += pedido.total || 0;
                    }
                    
                    stats.receitaTotal += pedido.total || 0;
                });
                
                await db.collection('estatisticas_plataforma').doc('geral').set(stats);
                exibirEstatisticas(stats);
                
            } catch (error) {
                console.error('Erro ao criar estat√≠sticas padr√£o:', error);
            }
        }

        function exibirEstatisticas(stats) {
            const statsGrid = document.getElementById('stats-grid');
            
            statsGrid.innerHTML = `
                <div class="stat-card">
                    <div class="stat-icon">üë•</div>
                    <div class="stat-value">${stats.totalUsuarios || 0}</div>
                    <div class="stat-label">Usu√°rios Ativos</div>
                    <div class="stat-change change-up">+12% este m√™s</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon">üè™</div>
                    <div class="stat-value">${stats.totalRestaurantes || 0}</div>
                    <div class="stat-label">Restaurantes</div>
                    <div class="stat-change change-up">+5% este m√™s</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon">üöö</div>
                    <div class="stat-value">${stats.totalEntregadores || 0}</div>
                    <div class="stat-label">Entregadores</div>
                    <div class="stat-change change-up">+8% este m√™s</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon">üì¶</div>
                    <div class="stat-value">${stats.totalPedidos || 0}</div>
                    <div class="stat-label">Total de Pedidos</div>
                    <div class="stat-change change-up">+15% este m√™s</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon">üí∞</div>
                    <div class="stat-value">R$ ${(stats.receitaTotal || 0).toFixed(2)}</div>
                    <div class="stat-label">Receita Total</div>
                    <div class="stat-change change-up">+18% este m√™s</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon">üìä</div>
                    <div class="stat-value">${stats.pedidosHoje || 0}</div>
                    <div class="stat-label">Pedidos Hoje</div>
                    <div class="stat-change change-up">+22% vs ontem</div>
                </div>
            `;
        }

        async function carregarAtividadesRecentes() {
            try {
                // Carregar atividades recentes (√∫ltimas 10)
                const atividadesRef = db.collection('atividades_sistema')
                    .orderBy('timestamp', 'desc')
                    .limit(10);
                
                unsubscribeActivity = atividadesRef.onSnapshot((snapshot) => {
                    const atividades = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    exibirAtividadesRecentes(atividades);
                }, (error) => {
                    console.error('Erro ao carregar atividades:', error);
                    exibirAtividadesRecentes([]);
                });
                
            } catch (error) {
                console.error('Erro ao carregar atividades:', error);
                exibirAtividadesRecentes([]);
            }
        }

        function exibirAtividadesRecentes(atividades) {
            const container = document.getElementById('activity-container');
            
            if (atividades.length === 0) {
                container.innerHTML = '<div class="no-data">Nenhuma atividade recente</div>';
                return;
            }
            
            container.innerHTML = atividades.map(atividade => {
                const icon = getActivityIcon(atividade.tipo);
                const time = new Date(atividade.timestamp.toDate()).toLocaleString('pt-BR');
                
                return `
                    <div class="activity-item">
                        <div class="activity-icon ${atividade.tipo}">${icon}</div>
                        <div class="activity-content">
                            <h4>${atividade.titulo}</h4>
                            <p>${atividade.descricao}</p>
                        </div>
                        <div class="activity-time">${time}</div>
                    </div>
                `;
            }).join('');
        }

        function getActivityIcon(tipo) {
            switch (tipo) {
                case 'user': return 'üë§';
                case 'restaurant': return 'üè™';
                case 'order': return 'üì¶';
                case 'delivery': return 'üöö';
                default: return 'üìã';
            }
        }

        async function carregarAlertasSistema() {
            try {
                // Simular alertas do sistema (em produ√ß√£o, viriam do Firestore)
                const alertas = [
                    {
                        tipo: 'info',
                        titulo: 'Sistema Atualizado',
                        mensagem: 'A plataforma foi atualizada para a vers√£o 2.1.0',
                        timestamp: new Date()
                    },
                    {
                        tipo: 'success',
                        titulo: 'Backup Realizado',
                        mensagem: 'Backup autom√°tico do banco de dados conclu√≠do com sucesso',
                        timestamp: new Date(Date.now() - 2 * 60 * 60 * 1000)
                    },
                    {
                        tipo: 'warning',
                        titulo: 'Alta Demanda',
                        mensagem: 'Pico de pedidos detectado - considere escalar servidores',
                        timestamp: new Date(Date.now() - 4 * 60 * 60 * 1000)
                    }
                ];
                
                exibirAlertasSistema(alertas);
                
            } catch (error) {
                console.error('Erro ao carregar alertas:', error);
                exibirAlertasSistema([]);
            }
        }

        function exibirAlertasSistema(alertas) {
            const container = document.getElementById('alerts-container');
            
            if (alertas.length === 0) {
                container.innerHTML = '<div class="no-data">Nenhum alerta ativo</div>';
                return;
            }
            
            container.innerHTML = alertas.map(alerta => {
                const time = new Date(alerta.timestamp).toLocaleString('pt-BR');
                
                return `
                    <div class="alert-item alert-${alerta.tipo}">
                        <div class="alert-header">
                            <div class="alert-title">${alerta.titulo}</div>
                            <div class="alert-time">${time}</div>
                        </div>
                        <div class="alert-message">${alerta.mensagem}</div>
                    </div>
                `;
            }).join('');
        }

        function irPara(pagina) {
            window.location.href = pagina;
        }

        async function fazerLogout() {
            try {
                if (unsubscribeStats) unsubscribeStats();
                if (unsubscribeActivity) unsubscribeActivity();
                
                await auth.signOut();
                localStorage.removeItem('user');
                window.location.href = 'cadastro_login_admin.html';
            } catch (error) {
                console.error('Erro ao fazer logout:', error);
            }
        }

        // Verificar se j√° est√° logado
        auth.onAuthStateChanged((user) => {
            if (user) {
                db.collection('usuarios').doc(user.uid).get().then((doc) => {
                    if (doc.exists && doc.data().tipo === 'admin') {
                        // J√° est√° logado como admin
                        currentUser = { uid: user.uid, email: user.email, ...doc.data() };
                        atualizarInterface();
                        carregarDados();
                    } else {
                        window.location.href = 'cadastro_login_admin.html';
                    }
                });
            } else {
                window.location.href = 'cadastro_login_admin.html';
            }
        });
    </script>
</body>
</html>
