<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JUSTA - Corrida em Andamento</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, #2196F3, #1976D2);
            color: white;
            padding: 1rem 1.5rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
        }

        .logo {
            font-size: 1.8rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .ride-status {
            background: rgba(255, 255, 255, 0.2);
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .back-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
        }

        .back-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .main-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem 1.5rem;
        }

        .ride-progress {
            background: white;
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }

        .progress-steps {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            position: relative;
        }

        .progress-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            flex: 1;
            position: relative;
            z-index: 2;
        }

        .progress-step:not(:last-child)::after {
            content: '';
            position: absolute;
            top: 20px;
            left: 60%;
            width: 80%;
            height: 2px;
            background: #e0e0e0;
            z-index: 1;
        }

        .progress-step.active:not(:last-child)::after {
            background: #4CAF50;
        }

        .step-number {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #e0e0e0;
            color: #666;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            z-index: 2;
            position: relative;
            transition: all 0.3s ease;
        }

        .progress-step.active .step-number {
            background: #4CAF50;
            color: white;
            transform: scale(1.1);
        }

        .progress-step.completed .step-number {
            background: #4CAF50;
            color: white;
        }

        .step-label {
            font-size: 0.9rem;
            color: #666;
            text-align: center;
            font-weight: 500;
        }

        .progress-step.active .step-label {
            color: #4CAF50;
            font-weight: 600;
        }

        .progress-step.completed .step-label {
            color: #4CAF50;
        }

        .ride-info {
            background: white;
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
        }

        .info-item {
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 15px;
            border-left: 4px solid #2196F3;
        }

        .info-item h4 {
            color: #333;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .info-item p {
            color: #666;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .ride-status-section {
            background: white;
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }

        .status-display {
            text-align: center;
            padding: 1rem;
            background: #e3f2fd;
            border-radius: 15px;
            border: 2px solid #2196F3;
        }

        .status-display p {
            font-size: 1.2rem;
            font-weight: 600;
            color: #1976D2;
            margin: 0;
        }

        .passenger-section {
            background: white;
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }

        .passenger-info {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .passenger-avatar {
            width: 60px;
            height: 60px;
            background: #e3f2fd;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            border: 3px solid #2196F3;
        }

        .passenger-details h4 {
            color: #333;
            margin-bottom: 0.5rem;
            font-size: 1.2rem;
        }

        .passenger-phone {
            color: #666;
            margin-bottom: 0.5rem;
            font-size: 1rem;
        }

        .passenger-rating {
            color: #ff9800;
            font-weight: 600;
            font-size: 1rem;
        }

        .passenger-actions {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .action-btn {
            padding: 0.8rem 1.5rem;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .call-btn {
            background: #4caf50;
            color: white;
        }

        .call-btn:hover {
            background: #45a049;
            transform: translateY(-2px);
        }

        .message-btn {
            background: #2196F3;
            color: white;
        }

        .message-btn:hover {
            background: #1976D2;
            transform: translateY(-2px);
        }

        .btn {
            padding: 0.8rem 1.5rem;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            margin: 0.5rem;
        }

        .btn-primary {
            background: #2196F3;
            color: white;
        }

        .btn-primary:hover {
            background: #1976D2;
            transform: translateY(-2px);
        }

        .btn-success {
            background: #4caf50;
            color: white;
        }

        .btn-success:hover {
            background: #45a049;
            transform: translateY(-2px);
        }

        .btn-info {
            background: #00bcd4;
            color: white;
        }

        .btn-info:hover {
            background: #0097a7;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #757575;
            color: white;
        }

        .btn-secondary:hover {
            background: #616161;
            transform: translateY(-2px);
        }

        .btn-danger {
            background: #f44336;
            color: white;
        }

        .btn-danger:hover {
            background: #d32f2f;
            transform: translateY(-2px);
        }

        .map-container {
            background: white;
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
            height: 400px;
            position: relative;
        }

        .map-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .map-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #333;
        }

        .map-actions {
            display: flex;
            gap: 0.5rem;
        }

        .map-btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: #f0f0f0;
            color: #333;
        }

        .map-btn:hover {
            background: #e0e0e0;
        }

        #map {
            height: 300px;
            width: 100%;
            border-radius: 15px;
            z-index: 1;
        }

        .map-loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: #666;
        }

        .ride-actions {
            background: white;
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .action-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .main-action-btn {
            padding: 16px 32px;
            border: none;
            border-radius: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .start-ride-btn {
            background: #4CAF50;
            color: white;
        }

        .start-ride-btn:hover {
            background: #45a049;
            transform: translateY(-2px);
        }

        .complete-ride-btn {
            background: #FF9800;
            color: white;
        }

        .complete-ride-btn:hover {
            background: #F57C00;
            transform: translateY(-2px);
        }

        .cancel-ride-btn {
            background: #f44336;
            color: white;
        }

        .cancel-ride-btn:hover {
            background: #d32f2f;
            transform: translateY(-2px);
        }

        .status-updates {
            background: white;
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }

        .status-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 1.5rem;
        }

        .status-list {
            display: grid;
            gap: 1rem;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #2196F3;
        }

        .status-time {
            color: #666;
            font-size: 0.9rem;
            min-width: 80px;
        }

        .status-text {
            color: #333;
            font-weight: 500;
        }

        .loading {
            text-align: center;
            padding: 3rem;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #2196F3;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #4CAF50;
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
            max-width: 350px;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.error {
            background: #f44336;
        }

        .notification.warning {
            background: #ff9800;
        }

        .notification.info {
            background: #2196F3;
        }

        .notification.success {
            background: #4CAF50;
        }

        .route-info {
            background: #e3f2fd;
            padding: 1rem 1.25rem;
            border-radius: 12px;
            margin-top: 1rem;
            border-left: 4px solid #2196F3;
        }

        .route-info h4 {
            color: #2e7d32;
            margin-bottom: 0.5rem;
        }

        .route-details {
            display: flex;
            justify-content: space-between;
            gap: 12px;
            color: #1565c0;
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }
            
            .progress-steps {
                flex-direction: column;
                gap: 1rem;
            }
            
            .progress-step:not(:last-child)::after {
                display: none;
            }
            
            .info-grid {
                grid-template-columns: 1fr;
            }
            
            .passenger-actions {
                flex-direction: column;
            }
            
            .action-buttons {
                grid-template-columns: 1fr;
            }
            
            .map-container {
                height: 350px;
            }
            
            #map {
                height: 250px;
            }
        }
        .direction-arrow {
        color: #4285F4;
        font-size: 20px;
        text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        transform-origin: center;
    }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <div class="logo">🚗 JUSTA</div>
            <div class="ride-status" id="rideStatus">Carregando...</div>
            <a href="home.html" class="back-btn">← Voltar</a>
        </div>
    </div>

    <div class="main-content">
        <!-- Progresso da Corrida -->
        <div class="ride-progress">
            <div class="progress-steps">
                <div class="progress-step" id="step1">
                    <div class="step-number">1</div>
                    <div class="step-label">Aceita</div>
                </div>
                <div class="progress-step" id="step2">
                    <div class="step-number">2</div>
                    <div class="step-label">A caminho</div>
                </div>
                <div class="progress-step" id="step3">
                    <div class="step-number">3</div>
                    <div class="step-label">Chegou</div>
                </div>
                <div class="progress-step" id="step4">
                    <div class="step-number">4</div>
                    <div class="step-label">Em viagem</div>
                </div>
                <div class="progress-step" id="step5">
                    <div class="step-number">5</div>
                    <div class="step-label">Finalizada</div>
                </div>
            </div>
        </div>

        <!-- Informações da Corrida -->
        <div class="ride-info">
            <div class="info-grid">
                <div class="info-item">
                    <h4>🚗 ID da Corrida</h4>
                    <p id="rideId">Carregando...</p>
                </div>
                <div class="info-item">
                    <h4>📍 Origem</h4>
                    <p id="origin">Carregando...</p>
                </div>
                <div class="info-item">
                    <h4>🎯 Destino</h4>
                    <p id="destination">Carregando...</p>
                </div>
                <div class="info-item">
                    <h4>📏 Distância Estimada</h4>
                    <p id="estimatedDistance">Calculando...</p>
                </div>
                <div class="info-item">
                    <h4>⏱️ Tempo Estimado</h4>
                    <p id="estimatedDuration">Calculando...</p>
                </div>
                <div class="info-item">
                    <h4>💰 Tarifa Estimada</h4>
                    <p id="estimatedFare">Calculando...</p>
                </div>
            </div>
        </div>

        <!-- Status da Corrida -->
        <div class="ride-status-section">
            <h3>📊 Status da Corrida</h3>
            <div class="status-display">
                <p id="currentStatus">Carregando...</p>
            </div>
        </div>

        <!-- Informações do Passageiro -->
        <div class="passenger-section" id="passengerSection" style="display: none;">
            <h3>👤 Informações do Passageiro</h3>
            <div class="passenger-info">
                <div class="passenger-avatar" id="passengerAvatar">👤</div>
                <div class="passenger-details">
                    <h4 id="passengerName">Passageiro</h4>
                    <p class="passenger-phone" id="passengerPhone">📞 Telefone não disponível</p>
                    <p class="passenger-rating" id="passengerRating">⭐ 0.0 (0 corridas)</p>
                </div>
            </div>
            
            <div class="passenger-actions">
                <button class="action-btn call-btn" onclick="callPassenger()">
                    📞 Ligar
                </button>
                <button class="action-btn message-btn" onclick="messagePassenger()">
                    💬 Mensagem
                </button>
            </div>
        </div>

        <!-- Mapa -->
        <div class="map-container">
            <div class="map-header">
                <h3 class="map-title">🗺️ Navegação</h3>
                <div class="map-actions">
                    <button class="map-btn" onclick="openInGoogleMaps()">
                        <span>🌎</span> Google Maps
                    </button>
                    <button class="map-btn" onclick="openInWaze()">
                        <span>📍</span> Waze
                    </button>
                </div>
            </div>
            <div id="map">
                <div class="map-loading">
                    <div class="spinner"></div>
                    <p>Carregando mapa...</p>
                </div>
            </div>
            <div class="route-info" id="routeInfo" style="display: none;">
                <h4>📊 Informações da Rota</h4>
                <div class="route-details">
                    <span id="routeDistance">-- km</span>
                    <span id="routeDuration">-- min</span>
                </div>
            </div>
        </div>

        <!-- Atualizações de Status -->
        <div class="status-updates">
            <h3 class="status-title">📝 Atualizações de Status</h3>
            <div class="status-list" id="statusList">
                <div class="status-item">
                    <div class="status-time">Agora</div>
                    <div class="status-text">Carregando informações da corrida</div>
                </div>
            </div>
        </div>

        <!-- Ações da Corrida -->
        <div class="ride-actions">
            <h3>🚗 Ações da Corrida</h3>
            <div class="action-buttons" id="actionButtons">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Carregando ações...</p>
                </div>
            </div>
            <div id="passengerConfirmBox" style="display:none; margin-top:16px; background:#fff3cd; border:1px solid #ffeaa7; border-radius:12px; padding:14px;">
                <div style="font-weight:600;color:#8a6d3b;margin-bottom:8px;">Confirme o passageiro com o código</div>
                <div style="display:flex; gap:8px; align-items:center;">
                    <input id="verificationInput" type="text" maxlength="4" placeholder="código" style="flex:1;padding:10px;border-radius:8px;border:1px solid #e0e0e0;font-size:16px; text-align:center; letter-spacing:4px;" />
                    <button class="main-action-btn start-ride-btn" onclick="confirmPassengerCode()">Confirmar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Notificação -->
    <div class="notification" id="notification"></div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-storage-compat.js"></script>
    
    <!-- Leaflet JS para mapas -->
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    
    <!-- Configuração do Firebase -->
    <script src="../assets/firebase-config.js"></script>

    <script>
        // Variáveis globais
        let currentRide = null;
        let currentRideStatus = 'pending';
        let db = null;
        let auth = null;
        let map = null;
        let routeLayer = null;
        let userMarker = null;
        let passengerMarker = null;
        let destinationMarker = null;
        let watchId = null;
        let rideListenerUnsubscribe = null;
        let lastProcessedUpdateTime = 0;
        let driverCurrentCoords = null;
        let driverLocationWatchId = null;
    
        // Aguardar o Firebase estar pronto
        async function initializeApp() {
            try {
                console.log('🚀 Iniciando aplicação do motorista...');
                
                await waitForFirebase();
                console.log('✅ Firebase configurado, verificando autenticação...');
                
                // Verificar se está logado
                const userId = localStorage.getItem('userId');
                if (!userId) {
                    console.log('⚠️ Usuário não está logado, redirecionando...');
                    window.location.href = 'login.html';
                    return;
                }
                
                console.log('✅ Usuário autenticado, verificando tipo...');
                const userType = localStorage.getItem('userType');
                console.log('👤 Tipo de usuário:', userType);
                
                if (userType !== 'motorista') {
                    console.log('⚠️ Usuário não é motorista, redirecionando...');
                    localStorage.clear();
                    window.location.href = 'login.html';
                    return;
                }
                
                console.log('✅ Usuário é motorista, inicializando mapa...');
                
                // Inicializar mapa
                initMap();
                
                // Iniciar monitoramento de localização
                await startDriverLocationTracking();
                
                // Carregar dados da corrida se houver rideId na URL
                await loadRideData();
                
                // Configurar listener em tempo real se houver uma corrida
                if (getRideId()) {
                    setupRideListener();
                }
                
                console.log('✅ Aplicação do motorista inicializada com sucesso!');
                
            } catch (error) {
                console.error('❌ Erro ao inicializar aplicação:', error);
                showNotification('Erro ao carregar a aplicação. Tente recarregar a página.', 'error');
            }
        }
    
        // Inicializar mapa
        function initMap() {
            // Inicializar o mapa centrado em uma localização padrão (ex: São Paulo)
            map = L.map('map').setView([-23.5505, -46.6333], 13);
            
            // Adicionar camada do OpenStreetMap
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
            
            console.log('🗺️ Mapa inicializado');
        }
    
        // Iniciar monitoramento de localização do motorista
        async function startDriverLocationTracking() {
            try {
                if (!navigator.geolocation) {
                    console.error('❌ Geolocalização não suportada');
                    showNotification('Seu navegador não suporta geolocalização', 'warning');
                    return;
                }
                
                console.log('📍 Iniciando monitoramento de localização do motorista...');
                
                // Obter localização atual primeiro
                const position = await new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(resolve, reject, {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    });
                });
                
                driverCurrentCoords = {
                    latitude: position.coords.latitude,
                    longitude: position.coords.longitude
                };
                
                // Atualizar localização no Firestore
                await updateDriverLocation(driverCurrentCoords);
                
                // Iniciar watch para atualizações contínuas
                driverLocationWatchId = navigator.geolocation.watchPosition(
                // No watchPosition callback, adicione:
                async (position) => {
                    driverCurrentCoords = {
                        latitude: position.coords.latitude,
                        longitude: position.coords.longitude
                    };
                    
                    // Atualizar localização no Firestore
                    await updateDriverLocation(driverCurrentCoords);
                    
                    // Atualizar marcador no mapa
                    updateUserLocation(driverCurrentCoords);
                    
                    // Se estiver em uma corrida, atualizar a rota
                    if (currentRide) {
                        updateRouteForStatus(currentRide);
                        
                        // Verificar se chegou ao destino (apenas quando em viagem com passageiro)
                        if (currentRide.status === 'in_progress' && currentRide.passengerConfirmed) {
                            checkArrivalAndComplete(driverCurrentCoords, currentRide);
                        }
                    }
                },
                    (error) => {
                        console.error('❌ Erro ao obter localização:', error);
                        showNotification('Erro ao obter localização', 'error');
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 20000,
                        maximumAge: 60000
                    }
                );
                
                // Centralizar mapa na localização atual
                map.setView([driverCurrentCoords.latitude, driverCurrentCoords.longitude], 15);
                updateUserLocation(driverCurrentCoords);
                
            } catch (error) {
                console.error('❌ Erro ao iniciar monitoramento de localização:', error);
                showNotification('Erro ao obter localização. Verifique as permissões.', 'error');
            }
        }
    
        // Atualizar localização do motorista no Firestore
        async function updateDriverLocation(coords) {
            try {
                const userId = localStorage.getItem('userId');
                if (userId && db) {
                    await db.collection('users').doc(userId).update({
                        currentLocation: new firebase.firestore.GeoPoint(coords.latitude, coords.longitude),
                        lastLocationUpdate: new Date()
                    });
                }
            } catch (error) {
                console.error('❌ Erro ao atualizar localização no Firestore:', error);
            }
        }
    
        // Inicializar quando a página carregar
        document.addEventListener('DOMContentLoaded', initializeApp);
    
        // Carregar dados da corrida
        async function loadRideData() {
            try {
                console.log('🔍 Iniciando carregamento dos dados da corrida...');
                
                // Verificar se o Firestore está disponível
                if (!db) {
                    throw new Error('Firestore não está disponível');
                }
                
                const urlParams = new URLSearchParams(window.location.search);
                const rideId = urlParams.get('rideId');
                
                console.log('🔍 ID da corrida da URL:', rideId);
                
                if (!rideId) {
                    console.log('ℹ️ Nenhuma corrida específica para carregar');
                    return;
                }
                
                console.log('🔍 Buscando dados da corrida no Firestore...');
                const rideDoc = await db.collection('rides').doc(rideId).get();
                
                if (rideDoc.exists) {
                    const rideData = rideDoc.data();
                    rideData.id = rideId;
                    
                    console.log('✅ Dados da corrida carregados:', rideData);
                    
                    // Verificar se a corrida está dentro do raio de 10km
                    if (driverCurrentCoords && rideData.userLocation) {
                        const distance = getDistanceKm(
                            driverCurrentCoords.latitude, driverCurrentCoords.longitude,
                            rideData.userLocation.latitude, rideData.userLocation.longitude
                        );
                        
                        if (distance > 10) {
                            console.warn('⚠️ Corrida fora do raio de 10km, ignorando...');
                            showNotification('Esta corrida está fora da sua área de atuação', 'warning');
                            setTimeout(() => {
                                window.location.href = 'home.html';
                            }, 3000);
                            return;
                        }
                    }
                    
                    // Atualizar interface
                    updateRideInterface(rideData);
                    
                    // Calcular e exibir a rota adequada ao status
                    updateRouteForStatus(rideData);
                    
                } else {
                    console.error('❌ Corrida não encontrada no Firestore');
                    showNotification('Corrida não encontrada', 'error');
                    setTimeout(() => {
                        window.location.href = 'home.html';
                    }, 2000);
                }
                
            } catch (error) {
                console.error('❌ Erro ao carregar dados da corrida:', error);
                showNotification('Erro ao carregar dados da corrida', 'error');
            }
        }
    
        // Calcular e exibir rota conforme status (driver->passenger antes de confirmar; depois passenger->destination)
        async function updateRouteForStatus(rideData) {
            let from = null;
            let to = null;
            let waypoints = [];
            
            try {
                if (!rideData) return;
                
                let labelPrefix = '';
                
                // Determinar origem e destino baseado no status da corrida
                if (rideData.status === 'accepted' || rideData.status === 'arrived') {
                    // Motorista indo até o passageiro
                    if (driverCurrentCoords && rideData.userLocation) {
                        from = { 
                            latitude: driverCurrentCoords.latitude, 
                            longitude: driverCurrentCoords.longitude 
                        };
                        to = { 
                            latitude: rideData.userLocation.latitude, 
                            longitude: rideData.userLocation.longitude 
                        };
                        labelPrefix = 'Até passageiro: ';
                    }
                } else if (rideData.status === 'in_progress' && rideData.passengerConfirmed) {
                    // Motorista com passageiro indo para o destino
                    if (driverCurrentCoords && rideData.destinationCoords) {
                        from = { 
                            latitude: driverCurrentCoords.latitude, 
                            longitude: driverCurrentCoords.longitude 
                        };
                        to = { 
                            latitude: rideData.destinationCoords.latitude, 
                            longitude: rideData.destinationCoords.longitude 
                        };
                        labelPrefix = 'Até destino: ';
                        
                        // Adicionar waypoints para melhorar a precisão da rota
                        if (rideData.optimizedWaypoints && rideData.optimizedWaypoints.length > 0) {
                            waypoints = rideData.optimizedWaypoints;
                        }
                    }
                }

                // Validar se temos coordenadas válidas
                if (!from || !to) {
                    console.log('⚠️ Coordenadas insuficientes para roteamento');
                    return;
                }

                // Verificar se as coordenadas são válidas
                if (!isValidCoordinate(from.latitude, from.longitude) || 
                    !isValidCoordinate(to.latitude, to.longitude)) {
                    console.error('❌ Coordenadas inválidas para roteamento');
                    showNotification('Coordenadas inválidas para cálculo de rota', 'warning');
                    addMarkers(from, to);
                    return;
                }

                console.log('🛣️ Calculando rota otimizada...');
                console.log('📍 De:', from);
                console.log('🎯 Para:', to);
                if (waypoints.length > 0) {
                    console.log('📍 Waypoints:', waypoints.length);
                }
                
                // Calcular rota otimizada (similar ao Waze/Google Maps)
                await calculateOptimizedRoute(from, to, waypoints);
                
            } catch (error) {
                console.error('❌ Erro ao calcular rota:', error);
                showNotification('Erro ao calcular rota. Verifique as localizações.', 'error');
                
                // Tentar adicionar marcadores se tivermos coordenadas
                if (from && to) {
                    addMarkers(from, to);
                }
            }
        }
        // Calcular rota otimizada similar ao Waze/Google Maps
        async function calculateOptimizedRoute(from, to, waypoints = []) {
            try {
                // Construir URL da API OSRM com waypoints se disponíveis
                let coordinates = [];
                
                // Adicionar origem
                coordinates.push(`${from.longitude},${from.latitude}`);
                
                // Adicionar waypoints se existirem
                if (waypoints.length > 0) {
                    waypoints.forEach(wp => {
                        coordinates.push(`${wp.longitude},${wp.latitude}`);
                    });
                }
                
                // Adicionar destino
                coordinates.push(`${to.longitude},${to.latitude}`);
                
                const coordinatesString = coordinates.join(';');
                
                // Usar serviço de roteamento mais avançado
                const response = await fetch(`https://router.project-osrm.org/route/v1/driving/${coordinatesString}?overview=full&geometries=geojson&steps=true`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.code === 'Ok') {
                    // Processar rota calculada
                    const route = data.routes[0];
                    const distance = (route.distance / 1000).toFixed(1);
                    const duration = Math.ceil(route.duration / 60);
                    
                    console.log(`📊 Rota calculada: ${distance} km, ${duration} min`);
                    
                    // Atualizar UI
                    document.getElementById('routeDistance').textContent = `${distance} km`;
                    document.getElementById('routeDuration').textContent = `${duration} min`;
                    document.getElementById('routeInfo').style.display = 'block';
                    
                    displayOptimizedRouteOnMap(route.geometry);
                    addMarkers(from, to);
                    
                } else {
                    console.error('❌ Erro ao calcular rota:', data.code);
                    // Fallback para rota simples
                    await calculateSimpleRoute(from, to);
                }
                
            } catch (error) {
                console.error('❌ Erro ao calcular rota otimizada:', error);
                // Fallback para rota simples
                await calculateSimpleRoute(from, to);
            }
        }
            // Exibir rota otimizada no mapa
        function displayOptimizedRouteOnMap(geometry) {
            // Limpar rota anterior se existir
            if (routeLayer) {
                map.removeLayer(routeLayer);
            }
            
            // Converter geometria para formato Leaflet
            const routeCoordinates = geometry.coordinates.map(coord => [coord[1], coord[0]]);
            
            // Criar camada da rota com estilo melhorado
            routeLayer = L.polyline(routeCoordinates, {
                color: '#4285F4', // Azul similar ao Google Maps
                weight: 6,
                opacity: 0.8,
                lineJoin: 'round',
                dashArray: null // Linha sólida
            }).addTo(map);
            
            // Adicionar setas de direção ao longo da rota
            addDirectionArrows(routeCoordinates);
            
            // Ajustar visualização do mapa para mostrar toda a rota com padding
            map.fitBounds(routeLayer.getBounds(), { 
                padding: [50, 50],
                maxZoom: 15 // Limitar zoom máximo para melhor visualização
            });
            
            console.log('🗺️ Rota otimizada exibida no mapa');
        }
        // Função para validar coordenadas geográficas
        function isValidCoordinate(lat, lng) {
            return lat >= -90 && lat <= 90 && 
                   lng >= -180 && lng <= 180;
        }
        function addDirectionArrows(coordinates) {
            // Remover setas anteriores
            map.eachLayer(layer => {
                if (layer instanceof L.Marker && layer.options && layer.options.isDirectionArrow) {
                    map.removeLayer(layer);
                }
            });
            
            // Adicionar setas a cada 10% do percurso
            const arrowPositions = [0.2, 0.4, 0.6, 0.8];
            
            arrowPositions.forEach(position => {
                const index = Math.floor(coordinates.length * position);
                if (index < coordinates.length - 1) {
                    const point = coordinates[index];
                    const nextPoint = coordinates[index + 1];
                    
                    // Calcular ângulo da seta
                    const angle = Math.atan2(nextPoint[1] - point[1], nextPoint[0] - point[0]) * 180 / Math.PI;
                    
                    // Criar marcador de seta
                    const arrow = L.marker(point, {
                        icon: L.divIcon({
                            html: '➤',
                            className: 'direction-arrow',
                            iconSize: [20, 20],
                            iconAnchor: [10, 10]
                        }),
                        isDirectionArrow: true
                    }).addTo(map);
                    
                    // Rotacionar a seta
                    arrow.getElement().style.transform = `rotate(${angle}deg)`;
                }
            });
        }
        // Função para calcular distância entre coordenadas (Haversine)
        function getDistanceKm(lat1, lon1, lat2, lon2) {
            const R = 6371; // Raio da Terra em km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = 
                Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI/180) * Math.cos(lat2 * Math.PI/180) * 
                Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            const distance = R * c;
            
            return distance;
        }
    
        // Exibir rota no mapa
        function displayRouteOnMap(geometry) {
            // Limpar rota anterior se existir
            if (routeLayer) {
                map.removeLayer(routeLayer);
            }
            
            // Converter geometria para formato Leaflet
            const routeCoordinates = geometry.coordinates.map(coord => [coord[1], coord[0]]);
            
            // Criar camada da rota
            routeLayer = L.polyline(routeCoordinates, {
                color: '#2196F3',
                weight: 5,
                opacity: 0.7,
                lineJoin: 'round'
            }).addTo(map);
            
            // Ajustar visualização do mapa para mostrar toda a rota
            map.fitBounds(routeLayer.getBounds(), { padding: [50, 50] });
            
            console.log('🗺️ Rota exibida no mapa');
        }
    
        function checkArrivalAndComplete(coords, rideData) {
    try {
        if (!rideData || !rideData.destinationCoords || rideData.status !== 'in_progress' || !rideData.passengerConfirmed) {
            return;
        }
        
        const dest = rideData.destinationCoords;
        const distanceKm = getDistanceKm(coords.latitude, coords.longitude, dest.latitude, dest.longitude);
        
        console.log(`📍 Distância até destino: ${distanceKm.toFixed(3)} km`);
        
        // Considerar chegada quando dentro de 60 metros
        if (distanceKm <= 0.06) {
            console.log('🎯 Chegou ao destino, finalizando corrida automaticamente...');
            completeRide();
        }
    } catch (e) {
        console.error('Erro ao verificar chegada:', e);
    }
}
    
        // Adicionar marcadores ao mapa
        function addMarkers(fromCoords, toCoords) {
    // Limpar marcadores anteriores
    if (passengerMarker) map.removeLayer(passengerMarker);
    if (destinationMarker) map.removeLayer(destinationMarker);
    
    // Determinar qual marcador mostrar baseado no contexto
    if (currentRide && currentRide.status === 'in_progress' && currentRide.passengerConfirmed) {
        // Em viagem com passageiro: mostrar apenas destino
        destinationMarker = L.marker([toCoords.latitude, toCoords.longitude], {
            icon: L.divIcon({
                html: '🎯',
                className: 'destination-marker',
                iconSize: [30, 30]
            })
        }).addTo(map);
        
        // Ajustar visualização para mostrar destino
        map.setView([toCoords.latitude, toCoords.longitude], 15);
        
    } else if (currentRide && (currentRide.status === 'accepted' || currentRide.status === 'arrived')) {
        // Indo até passageiro: mostrar passageiro
        passengerMarker = L.marker([toCoords.latitude, toCoords.longitude], {
            icon: L.divIcon({
                html: '👤',
                className: 'passenger-marker',
                iconSize: [30, 30]
            })
        }).addTo(map);
        
        // Ajustar visualização para mostrar passageiro
        map.setView([toCoords.latitude, toCoords.longitude], 15);
    } else {
        // Caso padrão: mostrar ambos os pontos
        passengerMarker = L.marker([fromCoords.latitude, fromCoords.longitude], {
            icon: L.divIcon({
                html: '👤',
                className: 'passenger-marker',
                iconSize: [30, 30]
            })
        }).addTo(map);
        
        destinationMarker = L.marker([toCoords.latitude, toCoords.longitude], {
            icon: L.divIcon({
                html: '🎯',
                className: 'destination-marker',
                iconSize: [30, 30]
            })
        }).addTo(map);
        
        // Ajustar visualização para mostrar ambos os pontos
        const bounds = L.latLngBounds(
            [fromCoords.latitude, fromCoords.longitude],
            [toCoords.latitude, toCoords.longitude]
        );
        map.fitBounds(bounds, { padding: [50, 50] });
    }
    
    console.log('📍 Marcadores atualizados no mapa');
}
    
        // Atualizar localização do usuário no mapa
        function updateUserLocation(coords) {
            // Remover marcador anterior se existir
            if (userMarker) {
                map.removeLayer(userMarker);
            }if (currentRide) {
                // Usar debounce para evitar recálculos excessivos
                clearTimeout(window.routeRecalculationTimeout);
                window.routeRecalculationTimeout = setTimeout(() => {
                    updateRouteForStatus(currentRide);
                }, 2000); // Recalcular a cada 2 segundos
            }
            
            // Adicionar novo marcador
            userMarker = L.marker([coords.latitude, coords.longitude], {
                icon: L.divIcon({
                    html: '🚗',
                    className: 'user-marker',
                    iconSize: [30, 30]
                })
            }).addTo(map);
        }
    
        // Parar acompanhamento de localização
        function stopTracking() {
            if (watchId !== null) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
                console.log('📍 Acompanhamento de localização parado');
            }
            
            if (driverLocationWatchId !== null) {
                navigator.geolocation.clearWatch(driverLocationWatchId);
                driverLocationWatchId = null;
                console.log('📍 Monitoramento de localização do motorista parado');
            }
        }
    
        // Abrir no Google Maps
        function openInGoogleMaps() {
    if (!currentRide) {
        showNotification('Dados da corrida não disponíveis', 'warning');
        return;
    }
    
    let origin, destination;
    
    if (currentRide.status === 'accepted' || currentRide.status === 'arrived') {
        // Indo até o passageiro: motorista -> passageiro
        if (!driverCurrentCoords || !currentRide.userLocation) {
            showNotification('Coordenadas não disponíveis', 'warning');
            return;
        }
        
        origin = `${driverCurrentCoords.latitude},${driverCurrentCoords.longitude}`;
        destination = `${currentRide.userLocation.latitude},${currentRide.userLocation.longitude}`;
        
    } else if (currentRide.status === 'in_progress' && currentRide.passengerConfirmed) {
        // Indo para o destino: passageiro -> destino
        // AGORA: Usar a localização do passageiro como origem
        if (!currentRide.userLocation || !currentRide.destinationCoords) {
            showNotification('Coordenadas não disponíveis', 'warning');
            return;
        }
        
        origin = `${currentRide.userLocation.latitude},${currentRide.userLocation.longitude}`;
        destination = `${currentRide.destinationCoords.latitude},${currentRide.destinationCoords.longitude}`;
    } else {
        showNotification('Rota não disponível para o status atual', 'warning');
        return;
    }
    
    const url = `https://www.google.com/maps/dir/?api=1&origin=${origin}&destination=${destination}&travelmode=driving`;
    window.open(url, '_blank');
}
    
        // Abrir no Waze
        function openInWaze() {
    if (!currentRide) {
        showNotification('Dados da corrida não disponíveis', 'warning');
        return;
    }
    
    let lat, lng;
    
    if (currentRide.status === 'accepted' || currentRide.status === 'arrived') {
        // Indo até o passageiro
        if (!currentRide.userLocation) {
            showNotification('Coordenadas não disponíveis', 'warning');
            return;
        }
        
        lat = currentRide.userLocation.latitude;
        lng = currentRide.userLocation.longitude;
        
    } else if (currentRide.status === 'in_progress' && currentRide.passengerConfirmed) {
        // Indo para o destino
        // AGORA: Usar a localização do passageiro como origem
        if (!currentRide.userLocation || !currentRide.destinationCoords) {
            showNotification('Coordenadas não disponíveis', 'warning');
            return;
        }
        
        // Para o Waze, vamos usar o destino final
        lat = currentRide.destinationCoords.latitude;
        lng = currentRide.destinationCoords.longitude;
    } else {
        showNotification('Rota não disponível para o status atual', 'warning');
        return;
    }
    
    const url = `https://www.waze.com/ul?ll=${lat},${lng}&navigate=yes`;
    window.open(url, '_blank');
}
        // Atualizar interface da corrida
        function updateRideInterface(rideData) {
            console.log('🔄 Atualizando interface da corrida:', rideData);
            
            // Evitar atualizações desnecessárias
            if (currentRide && currentRide.updatedAt && rideData.updatedAt) {
                const currentTime = new Date(currentRide.updatedAt.seconds * 1000).getTime();
                const newTime = new Date(rideData.updatedAt.seconds * 1000).getTime();
                
                if (newTime <= currentTime && currentRideStatus === rideData.status) {
                    console.log('⏭️ Atualização ignorada (dados mais recentes já presentes)');
                    return;
                }
            }
            
            // Atualizar currentRide
            currentRide = rideData;
            
            // Atualizar status global apenas se for diferente
            if (rideData.status && rideData.status !== currentRideStatus) {
                currentRideStatus = rideData.status;
                console.log('📊 Status da corrida atualizado para:', currentRideStatus);
            }
            
            // Informações básicas
            document.getElementById('rideId').textContent = rideData.id || 'N/A';
            document.getElementById('origin').textContent = rideData.origin || 'N/A';
            document.getElementById('destination').textContent = rideData.destination || 'N/A';
            document.getElementById('estimatedDistance').textContent = `${rideData.estimatedDistance || 'N/A'} km`;
            document.getElementById('estimatedDuration').textContent = `${rideData.estimatedDuration || 'N/A'} min`;
            
            // Formatar preço
            const fareElement = document.getElementById('estimatedFare');
            if (fareElement) {
                if (window.utils && window.utils.formatCurrency) {
                    fareElement.textContent = window.utils.formatCurrency(rideData.estimatedFare || 0);
                } else {
                    fareElement.textContent = `R$ ${(rideData.estimatedFare || 0).toFixed(2)}`;
                }
            }
            
            console.log('✅ Informações básicas atualizadas');
            
            // Status da corrida
            updateRideStatusDisplay(rideData.status || 'pending');
            
            // Informações do passageiro
            if (rideData.passengerId) {
                console.log('👤 Carregando informações do passageiro...');
                loadPassengerInfo(rideData.passengerId);
            } else {
                console.log('⚠️ Nenhum passageiro associado à corrida');
            }
            
            // Atualizar botões de ação
            updateActionButtons(rideData.status || 'pending');
            if ((rideData.status === 'arrived') && !rideData.passengerConfirmed) {
                const box = document.getElementById('passengerConfirmBox');
                if (box) box.style.display = 'block';
            } else {
                const box = document.getElementById('passengerConfirmBox');
                if (box) box.style.display = 'none';
            }
    
            console.log('✅ Interface da corrida atualizada com sucesso');
        }
    
        // Atualizar status da corrida na interface
        function updateRideStatusDisplay(status) {
            const statusSteps = document.querySelectorAll('.progress-step');
            const currentStep = getCurrentStepIndex(status);
            
            statusSteps.forEach((step, index) => {
                step.classList.remove('completed', 'active');
                
                if (index < currentStep) {
                    step.classList.add('completed');
                } else if (index === currentStep) {
                    step.classList.add('active');
                }
            });
            
            // Atualizar texto do status
            const statusText = getStatusText(status);
            document.getElementById('currentStatus').textContent = statusText;
            document.getElementById('rideStatus').textContent = statusText;
            
            // Adicionar atualização de status apenas se for uma mudança real
            if (status !== currentRideStatus) {
                addStatusUpdate(`Status alterado para: ${statusText}`);
            }
        }
    
        // Obter índice do passo atual
        function getCurrentStepIndex(status) {
            const statusMap = {
                'accepted': 1,
                'arrived': 2,
                'in_progress': 3,
                'completed': 4,
                'cancelled': -1
            };
            return statusMap[status] || 0;
        }
    
        // Obter texto do status
        function getStatusText(status) {
            const statusTexts = {
                'accepted': 'A caminho do passageiro',
                'arrived': 'Chegou ao passageiro',
                'in_progress': 'Em viagem com passageiro',
                'completed': 'Corrida Finalizada',
                'cancelled': 'Corrida Cancelada'
            };
            return statusTexts[status] || 'Status desconhecido';
        }
    
        // Carregar informações do passageiro
        async function loadPassengerInfo(passengerId) {
            try {
                console.log('👤 Carregando informações do passageiro:', passengerId);
                
                // Verificar se o Firestore está disponível
                if (!db) {
                    throw new Error('Firestore não está disponível');
                }
                
                const passengerDoc = await db.collection('users').doc(passengerId).get();
                
                if (passengerDoc.exists) {
                    const passengerData = passengerDoc.data();
                    console.log('✅ Dados do passageiro carregados:', passengerData);
                    
                    document.getElementById('passengerName').textContent = passengerData.name || 'N/A';
                    
                    const phoneElement = document.getElementById('passengerPhone');
                    phoneElement.textContent = passengerData.phone ? `📞 ${passengerData.phone}` : '📞 Telefone não disponível';
                    
                    const ratingElement = document.getElementById('passengerRating');
                    ratingElement.textContent = `⭐ ${passengerData.rating?.toFixed(1) || '0.0'} (${passengerData.totalRides || 0} corridas)`;
                    
                    // Mostrar seção do passageiro
                    document.getElementById('passengerSection').style.display = 'block';
                    
                    console.log('✅ Interface do passageiro atualizada');
                } else {
                    console.warn('⚠️ Passageiro não encontrado no Firestore');
                }
            } catch (error) {
                console.error('❌ Erro ao carregar dados do passageiro:', error);
            }
        }
    
        // Atualizar botões de ação
        function updateActionButtons(status) {
            console.log('🔘 Atualizando botões de ação para status:', status);
            
            const actionButtons = document.getElementById('actionButtons');
            if (!actionButtons) return;
            
            let buttonsHTML = '';
            
            switch (status) {
                case 'accepted':
                    buttonsHTML = `
                        <button class="main-action-btn complete-ride-btn" onclick="arriveAtPassenger()">
                            🎯 Cheguei ao Passageiro
                        </button>
                    `;
                    break;
                    
                case 'arrived':
                    if (currentRide && currentRide.passengerConfirmed) {
                        // Passageiro confirmado, pode iniciar viagem
                        buttonsHTML = `
                            <button class="main-action-btn start-ride-btn" onclick="startTripWithPassenger()">
                                👉 Iniciar Viagem com Passageiro
                            </button>
                        `;
                    } else {
                        // Aguardando confirmação do passageiro
                        buttonsHTML = `
                            <div style="text-align: center; color: #666; padding: 1rem;">
                                ⏳ Aguardando confirmação do passageiro pelo código
                            </div>
                        `;
                    }
                    break;
                    
                case 'in_progress':
                    if (currentRide && currentRide.passengerConfirmed) {
                        // Em viagem com passageiro
                        buttonsHTML = `
                            <button class="main-action-btn complete-ride-btn" onclick="completeRide()">
                                ✅ Finalizar Corrida
                            </button>
                            <div style="text-align: center; color: #666; padding: 1rem; font-size: 0.9rem;">
                                🚗 Em viagem com passageiro para o destino
                            </div>
                        `;
                    } else {
                        // A caminho do passageiro
                        buttonsHTML = `
                            <button class="main-action-btn complete-ride-btn" onclick="arriveAtPassenger()">
                                🎯 Cheguei ao Passageiro
                            </button>
                        `;
                    }
                    break;
                    
                case 'completed':
                    buttonsHTML = `
                        <a href="corrida_finalizada.html?rideId=${getRideId()}" class="main-action-btn btn-info">
                            📋 Ver Resumo
                        </a>
                        <a href="home.html" class="main-action-btn btn-secondary">
                            🏠 Voltar ao Início
                        </a>
                    `;
                    stopTracking();
                    break;
                    
                case 'cancelled':
                    buttonsHTML = `
                        <a href="home.html" class="main-action-btn btn-secondary">
                            🏠 Voltar ao Início
                        </a>
                    `;
                    stopTracking();
                    break;
                    
                default:
                    buttonsHTML = `
                        <div style="text-align: center; color: #666; padding: 1rem;">
                            ⏳ Carregando ações...
                        </div>
                    `;
                    break;
            }
            
            actionButtons.innerHTML = buttonsHTML;
            console.log('✅ Botões de ação atualizados para status:', status);
        }
    
        // Configurar listener em tempo real
        function setupRideListener() {
            if (!db) {
                console.error('Firestore não está disponível para configurar listener');
                return;
            }
            
            const rideId = getRideId();
            if (!rideId) {
                console.error('ID da corrida não encontrado para configurar listener');
                return;
            }
            
            console.log('🔍 Configurando listener para corrida:', rideId);
            
            // Remover listener anterior se existir
            if (rideListenerUnsubscribe) {
                rideListenerUnsubscribe();
            }
            
            rideListenerUnsubscribe = db.collection('rides').doc(rideId).onSnapshot((doc) => {
                if (doc.exists) {
                    const rideData = doc.data();
                    rideData.id = rideId;
                    
                    // Evitar processamento excessivo
                    const now = Date.now();
                    if (now - lastProcessedUpdateTime < 1000) {
                        console.log('⏭️ Atualização ignorada (muitas atualizações em curto período)');
                        return;
                    }
                    
                    lastProcessedUpdateTime = now;
                    
                    console.log('📡 Atualização em tempo real recebida:', rideData);
                    
                    // Atualizar interface
                    updateRideInterface(rideData);
                }
            }, (error) => {
                console.error('❌ Erro no listener da corrida:', error);
            });
        }
    
        // Funções de ação da corrida
        async function arriveAtPassenger() {
            try {
                console.log('🎯 Motorista chegou ao passageiro');
                await updateRideStatus('arrived');
                
                // Mostrar caixa de confirmação do código
                const box = document.getElementById('passengerConfirmBox');
                if (box) box.style.display = 'block';
                
                addStatusUpdate('Chegou ao passageiro');
                
            } catch (error) {
                console.error('❌ Erro ao marcar chegada:', error);
                showNotification('Erro ao marcar chegada', 'error');
            }
        }
    
        async function startTripWithPassenger() {
            try {
                console.log('🚗 Iniciando viagem com passageiro');
                await updateRideStatus('in_progress');
                
                // Atualizar interface
                document.getElementById('currentStatus').textContent = 'Em viagem com passageiro';
                document.getElementById('rideStatus').textContent = 'Em viagem com passageiro';
                
                // Esconder caixa de confirmação
                const box = document.getElementById('passengerConfirmBox');
                if (box) box.style.display = 'none';
                
                addStatusUpdate('Viagem com passageiro iniciada');
                
                // Atualizar rota para destino
                if (currentRide) {
                    // Aguardar um pouco para garantir que o status foi atualizado
                    setTimeout(() => {
                        updateRouteForStatus(currentRide);
                    }, 500);
                }
                
            } catch (error) {
                console.error('❌ Erro ao iniciar viagem:', error);
                showNotification('Erro ao iniciar viagem', 'error');
            }
        }
    
        // Confirmar passageiro via código
        async function confirmPassengerCode() {
            try {
                const rideId = getRideId();
                const input = document.getElementById('verificationInput');
                
                if (!rideId || !input) return;
                
                const code = (input.value || '').trim();
                if (code.length !== 4) {
                    showNotification('Código inválido', 'warning');
                    return;
                }
                
                const rideDoc = await db.collection('rides').doc(rideId).get();
                if (!rideDoc.exists) return;
                
                const rideData = rideDoc.data();
                if (rideData.verificationCode === code) {
                    // Código correto, confirmar passageiro
                    await db.collection('rides').doc(rideId).update({ 
                        passengerConfirmed: true, 
                        updatedAt: new Date() 
                    });
                    
                    showNotification('Passageiro confirmado!', 'success');
                    
                    // Esconder caixa de confirmação
                    const box = document.getElementById('passengerConfirmBox');
                    if (box) box.style.display = 'none';
                    
                    // Atualizar estado local
                    currentRide = { ...(currentRide || {}), passengerConfirmed: true };
                    
                    // Atualizar botões
                    updateActionButtons('arrived');
                    
                    addStatusUpdate('Passageiro confirmado pelo código');
                    
                    // Atualizar rota para destino agora que confirmou o passageiro
                    setTimeout(() => {
                        updateRouteForStatus(currentRide);
                    }, 500);
                    
                } else {
                    showNotification('Código incorreto', 'error');
                    input.value = '';
                    input.focus();
                }
                
            } catch (error) {
                console.error('❌ Erro ao confirmar código:', error);
                showNotification('Erro ao confirmar código', 'error');
            }
        }
    
        async function completeRide() {
            try {
                console.log('✅ Finalizando corrida');
                await updateRideStatus('completed');
                
                addStatusUpdate('Corrida finalizada');
                
                // Redirecionar após um delay
                setTimeout(() => {
                    window.location.href = `corrida_finalizada.html?rideId=${getRideId()}`;
                }, 2000);
                
            } catch (error) {
                console.error('❌ Erro ao finalizar corrida:', error);
                showNotification('Erro ao finalizar corrida', 'error');
            }
        }
    
        async function cancelRide() {
            if (confirm('Tem certeza que deseja cancelar esta corrida?')) {
                await updateRideStatus('cancelled');
            }
        }
    
        // Função confirmRide que estava faltando
        async function confirmRide() {
            try {
                console.log('✅ Confirmando corrida');
                await updateRideStatus('accepted');
                
                addStatusUpdate('Corrida confirmada pelo motorista');
                
            } catch (error) {
                console.error('❌ Erro ao confirmar corrida:', error);
                showNotification('Erro ao confirmar corrida', 'error');
            }
        }
    
        // Atualizar status da corrida
        async function updateRideStatus(newStatus) {
            try {
                console.log('🔄 Atualizando status da corrida para:', newStatus);
                
                if (!db) {
                    throw new Error('Firestore não está disponível');
                }
                
                const rideId = getRideId();
                if (!rideId) {
                    throw new Error('ID da corrida não encontrado');
                }
                
                const updateData = {
                    status: newStatus,
                    updatedAt: new Date()
                };
                
                // Adicionar timestamp específico baseado no status
                switch (newStatus) {
                    case 'arrived':
                        updateData.arrivedAt = new Date();
                        break;
                    case 'in_progress':
                        updateData.startedAt = new Date();
                        break;
                    case 'completed':
                        updateData.completedAt = new Date();
                        break;
                    case 'cancelled':
                        updateData.cancelledAt = new Date();
                        break;
                }
                
                console.log('📝 Dados para atualização:', updateData);
                
                await db.collection('rides').doc(rideId).update(updateData);
                
                console.log('✅ Status atualizado com sucesso no Firestore');
                
                // Atualizar interface
                updateRideStatusDisplay(newStatus);
                updateActionButtons(newStatus);
                
                showNotification(`Status atualizado para: ${getStatusText(newStatus)}`, 'success');
                
            } catch (error) {
                console.error('❌ Erro ao atualizar status:', error);
                showNotification('Erro ao atualizar status da corrida', 'error');
            }
        }
    
        // Obter ID da corrida da URL
        function getRideId() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('rideId');
        }
    
        // Adicionar atualização de status
        async function addStatusUpdate(message) {
            try {
                console.log('📝 Adicionando atualização de status:', message);
                
                if (!db) {
                    throw new Error('Firestore não está disponível');
                }
                
                const rideId = getRideId();
                const userId = localStorage.getItem('userId');
                
                await db.collection('rides').doc(rideId).collection('statusUpdates').add({
                    message: message,
                    timestamp: new Date(),
                    userId: userId,
                    userType: 'driver'
                });
                
                // Atualizar a lista de status na interface
                const statusList = document.getElementById('statusList');
                if (statusList) {
                    const now = new Date();
                    const timeString = now.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                    
                    const statusItem = document.createElement('div');
                    statusItem.className = 'status-item';
                    statusItem.innerHTML = `
                        <div class="status-time">${timeString}</div>
                        <div class="status-text">${message}</div>
                    `;
                    
                    statusList.prepend(statusItem);
                }
                
                console.log('✅ Atualização de status adicionada com sucesso');
                
            } catch (error) {
                console.error('❌ Erro ao adicionar atualização:', error);
            }
        }
    
        function callPassenger() {
            console.log('📞 Tentando ligar para o passageiro...');
            if (currentRide && currentRide.passengerPhone) {
                console.log('✅ Abrindo telefone para:', currentRide.passengerPhone);
                window.open(`tel:${currentRide.passengerPhone}`, '_blank');
            } else {
                console.warn('⚠️ Telefone do passageiro não disponível');
                showNotification('Telefone do passageiro não disponível', 'warning');
            }
        }
    
        function messagePassenger() {
            console.log('💬 Tentando enviar mensagem para o passageiro...');
            showNotification('Chat em desenvolvimento', 'info');
        }
    
        // Função para mostrar notificações
        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            if (notification) {
                notification.textContent = message;
                notification.className = `notification show ${type}`;
                
                // Esconder após 3 segundos
                setTimeout(() => {
                    notification.classList.remove('show');
                }, 3000);
            } else {
                alert(message);
            }
        }
    
        // Aguardar Firebase estar pronto
        function waitForFirebase() {
            return new Promise((resolve, reject) => {
                console.log('⏳ Aguardando Firebase estar pronto...');
                const maxAttempts = 100;
                let attempts = 0;
                
                const checkFirebase = () => {
                    attempts++;
                    
                    if (typeof firebase !== 'undefined' && firebase.auth && firebase.firestore) {
                        console.log('✅ Firebase detectado, configurando...');
                        
                        if (!firebase.apps.length) {
                            console.log('⚙️ Inicializando Firebase...');
                            firebase.initializeApp({});
                        }
                        
                        db = firebase.firestore();
                        auth = firebase.auth();
                        
                        console.log('✅ Firebase configurado com sucesso');
                        resolve();
                    } else if (attempts >= maxAttempts) {
                        reject(new Error('Firebase não carregou em tempo hábil'));
                    } else {
                        setTimeout(checkFirebase, 100);
                    }
                };
                
                checkFirebase();
            });
        }
    
        // Expor funções globalmente
        window.arriveAtPassenger = arriveAtPassenger;
        window.startTripWithPassenger = startTripWithPassenger;
        window.completeRide = completeRide;
        window.cancelRide = cancelRide;
        window.callPassenger = callPassenger;
        window.messagePassenger = messagePassenger;
        window.openInGoogleMaps = openInGoogleMaps;
        window.openInWaze = openInWaze;
        window.confirmPassengerCode = confirmPassengerCode;
    
        // Limpar recursos quando a página for fechada
        window.addEventListener('beforeunload', () => {
            if (rideListenerUnsubscribe) {
                rideListenerUnsubscribe();
            }
            stopTracking();
        });
    </script>
</body>
</html>